---
title: "Controle data en data preparatie pipeline"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# packages
library(tidyverse)
library(sf)
library(mapview)
library(targets)

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Source
source(here::here("source", "R", "tar_read_sf.R"))

# Paths
mbag_dir <- here::here()
targets_store <- here::here("source", "targets", "data_preparation", "_targets")
```

# Doel

Data cleaning en preparatie verloopt via een targets pipeline waarbij verschillende stappen elkaar opvolgen.

```{r}
tar_visnetwork(script = paste0(targets_store, ".R"),
               store = targets_store)
```

In deze markdown controleren we 

1. Of deze pipeline de verwachte stappen correct doorloopt
2. De finale data op het einde van de pipeline voor onverwachte zaken, uitschieters ...

We doen dit voor de data van 2018-2024.

# Data preparatie workflow
## Amersfoord naar Lambert coördinaten (crs_pipeline)

In de eerste stap worden Amersfoord coördinaten naar Lambert coördinaten omgezet.
Dit gebeurt via een functie die op verschillende datasets goed getest is.

## Selectie punten MBAG steekproefkader (select_sampled_points)

In de tweede stap selecteren we de punten uit de totale dataset die tot het MBAG steekproefkader behoren.
Dit gebeurt via een "inner join" wat wil zeggen dat we kunnen nagaan of telpunten uit het steekproefkader niet bezocht zijn (bewust of onbewust).

```{r}
sample <- tar_read("sample", store = targets_store)

select_sampled_points <- tar_read_sf("select_sampled_points",
                                     store = targets_store)
```

Welke aantallen hebben we per stratum?

```{r}
sample %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

We kijken of we dezelfde aantallen vinden in de data.

```{r}
sample_visited <- select_sampled_points %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, openheid_klasse, sbp)

sample_visited %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

Er waren 201 telpunten in het steekproefkader, maar er zijn er 199 geteld.
Welke punten zijn niet geteld?

```{r}
setdiff(sample$pointid, sample_visited$plotnaam)
```

> Nagaan of deze bewust of onbewust niet geteld zijn

Notities manuele controle Johannes:

- Pl_25053.16: plek zelf moeilijk te gaan staan stoppen aan overkant weg wel
- Pl_45612.2: OK geen privé weg maar langs bedrijf

### Selecteer data binnen de telperiodes (select_time_periods)

We selecteren data binnen de correcte telperiodes.
Er zijn 4 telrondes:

- R1: 1 april - 20 april
- R2: 21 april - 10 mei
- R3: 11 mei - 10 juni
- R4: 21 juni - 15 juli

Verliezen we data indien we filteren binnen deze periodes?
Indien ja, hoeveel en waar?

```{r}
select_time_periods <- tar_read_sf("select_time_periods", store = targets_store)
```

In totaal vallen `r nrow(select_sampled_points) - nrow(select_time_periods)` waarnemingen buiten de telperiodes.

```{r}
obs_per_year <- select_sampled_points %>%
  st_drop_geometry() %>%
  count(regio, jaar)

obs_per_year_filtered <- select_time_periods %>%
  st_drop_geometry() %>%
  count(regio, jaar, name = "n_filtered")

obs_per_year %>%
  full_join(obs_per_year_filtered, by = join_by(regio, jaar)) %>%
  mutate(difference = n - n_filtered) %>%
  kable()
```

- Kempen
  - ok
- Oostelijke leemstreek
  - alleen voor pre-MBAG jaren, ok
- Polders:
  - verschil pre-MBAG jaren (2022-2023), ok
  - waarnemingen 2024 nakijken!
- Westelijke leemstreek
  - nakijken!
- Polders:
  - verschil pre-MBAG jaren (2022-2023), ok
  - waarnemingen 2024 nakijken!

```{r}

```



### Telpunten in finale dataset (mas_data_full)

```{r}
mas_data_full <- tar_read("mas_data_full", store = targets_store)
```

Alle punten zijn nog altijd aanwezig:

```{r}
mas_data_full %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, openheid_klasse, sbp) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

# Controle finale dataset

...

```{r}
mas_data_clean <- tar_read("mas_data_clean", store = targets_store)
```

```{r}
count_per_period <- mas_data_clean %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, periode_in_jaar, jaar) %>%
  count(regio, periode_in_jaar, jaar, name = "n_period")

for (reg in sort(unique(count_per_period$regio))) {
  p <- count_per_period %>%
    filter(regio == reg) %>%
    ggplot(aes(x = periode_in_jaar, y = n_period)) +
      geom_bar(stat = "identity") +
      geom_text(aes(label = n_period),
        position = position_dodge(width = 0.9), vjust = -0.25
      ) +
      facet_grid(rows = vars(regio), cols = vars(jaar)) +
      labs(x = "Telperiode", y = "Aantal telpunten")
  print(p)
}
```
