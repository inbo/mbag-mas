---
title: "Controle data en data preparatie pipeline"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# packages
library(tidyverse)
library(sf)
library(mapview)
library(leaflet)
library(targets)

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Source
source(here::here("source", "R", "tar_read_sf.R"))
source(here::here("source", "R", "predatoren_f.R"))

# Paths
mbag_dir <- here::here()
targets_store <- here::here("source", "targets", "data_preparation", "_targets")
```

# Doel

Data preparatie verloopt via een targets pipeline waarbij verschillende stappen elkaar opvolgen.

```{r, message=FALSE}
tar_visnetwork(script = paste0(targets_store, ".R"),
               store = targets_store)
```

In deze markdown controleren we ...

1. of deze pipeline de verwachte stappen correct doorloopt
2. of in de finale data, op het einde van de pipeline, onverwachte zaken, uitschieters ... aanwezig zijn
3. of de data klaar zijn voor publicatie op GBIF

We doen dit in dit rapport voor de data van 2018-2024.

# Data preparatie pipeline
## Amersfoord naar Lambert coördinaten (crs_pipeline)

In de eerste stap worden Amersfoord coördinaten naar Lambert coördinaten omgezet.
Dit gebeurt via een functie die op verschillende datasets goed getest is.

## Selectie punten MBAG steekproefkader (select_sampled_points)

In de tweede stap selecteren we de punten uit de totale dataset die tot het MBAG steekproefkader behoren.
Dit gebeurt via een "inner join" wat wil zeggen dat we kunnen nagaan of telpunten uit het steekproefkader niet bezocht zijn (bewust of onbewust).

```{r}
sample <- tar_read("sample", store = targets_store)

select_sampled_points <- tar_read_sf("select_sampled_points",
                                     store = targets_store)
```

Welke aantallen hebben we per stratum?

```{r}
# Calculate number of locations we should have
sample %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

We kijken of we dezelfde aantallen vinden in de data.

```{r}
# Calculate number of locations in data
sample_visited <- select_sampled_points %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, openheid_klasse, sbp)

sample_visited %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

Er waren 201 telpunten in het steekproefkader, maar er zijn er 199 geteld.
Welke punten zijn niet geteld?

```{r}
setdiff(sample$pointid, sample_visited$plotnaam)
```

> Nagaan of deze bewust of onbewust niet geteld zijn

- Pl_25053.16 is verkeerdelijk ingegeven als Pl_49572

Notities manuele controle Johannes:

- Pl_45612.2: OK geen privé weg maar langs bedrijf

## Selecteer data binnen de telperiodes (select_time_periods)

We selecteren data binnen de correcte telperiodes.
Er zijn 4 telrondes:

- R1: 1 april - 20 april
- R2: 21 april - 10 mei
- R3: 11 mei - 10 juni
- R4: 21 juni - 15 juli

Verliezen we data indien we filteren binnen deze periodes?
Indien ja, hoeveel en waar?

```{r}
select_time_periods <- tar_read_sf("select_time_periods", store = targets_store)
```

In totaal vallen `r nrow(select_sampled_points) - nrow(select_time_periods)` waarnemingen buiten de telperiodes.

```{r}
# Calculate difference in number of observations before and after filtering on
# counting periods
obs_per_year <- select_sampled_points %>%
  st_drop_geometry() %>%
  count(regio, jaar)

obs_per_year_filtered <- select_time_periods %>%
  st_drop_geometry() %>%
  count(regio, jaar, name = "n_filtered")

obs_per_year %>%
  full_join(obs_per_year_filtered, by = join_by(regio, jaar)) %>%
  mutate(difference = n - n_filtered) %>%
  kable()
```

- Kempen
  - ok
- Oostelijke leemstreek
  - verschil alleen voor pre-MBAG jaren (2018-2022), ok
- Polders:
  - verschil alleen voor pre-MBAG jaren (2022-2023), ok
  - 2024 nakijken!
- Westelijke leemstreek
  - 2024 nakijken!
- Zandleemstreek
  - 2024 nakijken!
- Zandstreek:
  - verschil pre-MBAG jaren (2022-2023), ok
  - 2024 nakijken!

**Polders**

```{r}
# Which occurrences fall outside periods?
oid_pl <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Polders", jaar == 2024) %>%
    pull(oid)

oid_pl_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Polders", jaar == 2024) %>%
    pull(oid)

oid_pl_diff <- setdiff(oid_pl, oid_pl_filtered)

# Count number of observations per location and date
obs_per_date_pl <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Polders",
         jaar == 2024,
         oid %in% oid_pl_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_pl %>%
  kable()
```

Dit zijn wintertellingen, dus is ok.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
# How many times are these locations counted in valid periods?
obs_per_period_pl <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Polders",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_pl$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_pl %>%
  kable()
```

Beerpolder is niet geteld in ronde 1.

**Westelijke leemstreek**

```{r}
# Which occurrences fall outside periods?
oid_wlm <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Westelijke leemstreek", jaar == 2024) %>%
    pull(oid)

oid_wlm_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Westelijke leemstreek", jaar == 2024) %>%
    pull(oid)

oid_wlm_diff <- setdiff(oid_wlm, oid_wlm_filtered)

# Count number of observations per location and date
obs_per_date_wlm <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Westelijke leemstreek",
         jaar == 2024,
         oid %in% oid_wlm_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_wlm %>%
  kable()
```

Deze punten zijn geteld tussen telrondes 3 en 4.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
# How many times are these locations counted in valid periods?
obs_per_period_wlm <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Westelijke leemstreek",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_wlm$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_wlm %>%
  kable()
```

Neen, deze locaties zijn niet in telperiode 4 geteld.

**Zandleemstreek**

```{r}
# Which occurrences fall outside periods?
oid_zlm <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Zandleemstreek", jaar == 2024) %>%
    pull(oid)

oid_zlm_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Zandleemstreek", jaar == 2024) %>%
    pull(oid)

oid_zlm_diff <- setdiff(oid_zlm, oid_zlm_filtered)

# Count number of observations per location and date
obs_per_date_zlm <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Zandleemstreek",
         jaar == 2024,
         oid %in% oid_zlm_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_zlm %>%
  kable()
```

Deze punten zijn geteld tussen telrondes 3 en 4.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
# How many times are these locations counted in valid periods?
obs_per_period_zlm <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Zandleemstreek",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_zlm$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_zlm %>%
  kable()
```

Neen, deze locaties zijn niet in telperiode 4 geteld.

**Zandstreek**

```{r}
# Which occurrences fall outside periods?
oid_za <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Zandstreek", jaar == 2024) %>%
    pull(oid)

oid_za_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Zandstreek", jaar == 2024) %>%
    pull(oid)

oid_za_diff <- setdiff(oid_za, oid_za_filtered)

# Count number of observations per location and date
obs_per_date_za <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Zandstreek",
         jaar == 2024,
         oid %in% oid_za_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_za %>%
  kable()
```

Dit zijn wintertellingen, dus is ok.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
# How many times are these locations counted in valid periods?
obs_per_period_za <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Zandstreek",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_za$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_za %>%
  kable()
```

ok.

We schrijven deze data weg zodat ze gecontroleerd kunnen worden.

```{r}
# Get all locations outside periods
locs_outside_periods <- bind_rows(
  obs_per_period_pl,
  obs_per_period_wlm,
  obs_per_period_zlm,
  obs_per_period_za
  ) %>%
  filter(n_periodes < 4) %>%
  distinct(plotnaam) %>%
  pull()

# Get removed data
delete_from_df <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(jaar == 2024,
         plotnaam %in% locs_outside_periods) %>%
  distinct(plotnaam, jaar, maand, dag, waarnemer = waarneme)

# Write out removed data
select_sampled_points %>%
  st_drop_geometry() %>%
  filter(jaar == 2024,
         plotnaam %in% locs_outside_periods) %>%
  distinct(plotnaam, jaar, maand, dag, waarnemer = waarneme) %>%
  anti_join(delete_from_df,
            by = join_by(plotnaam, jaar, maand, dag, waarnemer)) %>%
  write_csv(file.path(mbag_dir, "output", "data_controle",
                      "tellingen_buiten_telrondes.csv"))
```

## Herbereken afstand tot telpunt (calculate_obs_distance)

We herberekenen de afstand van de waarnemingen tot elk telpunt.
Grote verschillen kunnen wijzen op fouten.

```{r}
calculate_obs_distance <- tar_read_sf(
  "calculate_obs_distance", store = targets_store)
```

Zijn er punten waarbij het absolute verschil meer dan 2 m is?

```{r}
# Get original distances
distances_og <- select_time_periods %>%
  st_drop_geometry() %>%
  select(oid, plotnaam, regio, jaar, periode_in_jaar,
         distance2plot_og = distance2plot) %>%
  mutate(distance2plot_og = as.numeric(distance2plot_og))

# Get recalculated distances
distances_new <- calculate_obs_distance %>%
  st_drop_geometry() %>%
  select(oid, plotnaam, regio, jaar, periode_in_jaar,
         distance2plot_new = distance2plot)

# Calculate absolute difference between the two
outlying_distances <- distances_og %>%
  full_join(distances_new,
            by = join_by(oid, plotnaam, regio, jaar, periode_in_jaar)) %>%
  mutate(abs_diff = abs(distance2plot_og - distance2plot_new)) %>%
  filter(abs_diff > 2)

# How many mismatches do we have per region?
outlying_distances %>%
  group_by(regio) %>%
  summarise(
    n_plots = n_distinct(plotnaam),
    n_jaren = n_distinct(jaar),
    n_periodes = n_distinct(periode_in_jaar),
    max_diff = max(abs_diff),
    .groups = "drop") %>%
  arrange(regio) %>%
  kable()
```

Er duiken veel problemen op in de Oostelijke leemstreek 2018-2024 voor meerdere verschillende telpunten.
Voor de polders is er 1 probleemtelpunt.

```{r}
outlying_dist_groups <- outlying_distances %>%
  distinct(plotnaam, regio, jaar, periode_in_jaar)

# Get problematic observations
outlying_dist_obs <- calculate_obs_distance %>%
  inner_join(outlying_dist_groups,
             by = join_by(plotnaam, jaar, regio, periode_in_jaar)) %>%
  left_join(outlying_distances %>% select(oid, abs_diff),
            by = join_by(oid))

# Get problematic point locations
outlying_dist_plots <- outlying_dist_obs %>%
  st_drop_geometry() %>%
  distinct(regio, plotnaam, jaar, periode_in_jaar, x_coord, y_coord) %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 31370)

# Get problematic location circles
outlying_dist_circles <- outlying_dist_plots %>%
  st_buffer(300)
```

**Polders**

In de Polders gaat het om `r outlying_distances %>% filter(regio == "Polders") %>% distinct(plotnaam) %>% pull() %>% length()` punten in `r outlying_distances %>% filter(regio == "Polders") %>% distinct(jaar) %>% pull() %>% length()` jaren in `r outlying_distances %>% filter(regio == "Polders") %>% distinct(periode_in_jaar) %>% pull() %>% length()` telperiodes.

```{r}
# Data preparation
years <- outlying_dist_obs %>%
  filter(regio == "Polders") %>%
  distinct(jaar) %>%
  pull()

# Create an empty leaflet map
leaflet_map <- leaflet() %>%
  addTiles()

# Loop through each year and round, adding layers to the map
for (j in sort(years)) {
  periods <- outlying_dist_obs %>%
    filter(regio == "Polders",
           jaar == j) %>%
    distinct(periode_in_jaar) %>%
    pull()

  for (ronde in sort(periods)) {
    # Filter data for the current year and round
    circles <- outlying_dist_circles %>%
      filter(regio == "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    plots <- outlying_dist_plots %>%
      filter(regio == "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    observations <- outlying_dist_obs %>%
      filter(regio == "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)

    # Create title
    title <- paste("Jaar:", j, "- Ronde:", ronde)

    # Add the layers to the leaflet map with group names
    leaflet_map <- leaflet_map %>%
      addPolygons(data = circles, fillOpacity = 0.3, group = title) %>%
      addCircleMarkers(data = plots, radius = 3, color = "black",
                       group = title, label = ~plots$plotnaam) %>%
      addCircleMarkers(data = observations, fillOpacity = 0.8, radius = 5,
                       color = "red",
                       group = title, label = ~observations$abs_diff)
  }
}

# Calculate control groups
groups <- outlying_dist_obs %>%
  filter(regio == "Polders") %>%
  distinct(jaar, periode_in_jaar) %>%
  mutate(group = paste("Jaar:", jaar, "- Ronde:", periode_in_jaar)) %>%
  pull(group)

# Add layer control to toggle visibility of the facets
leaflet_map <- leaflet_map %>%
  addLayersControl(
    overlayGroups = groups,
    options = layersControlOptions(collapsed = FALSE)
  )

# Print the leaflet map
leaflet_map
```

Het ziet ernaar uit dat Pl_49572 dezelfde naam heeft voor 2 locaties.
In plaats van: Pl_25053.16 (x: 50279.09, y: 210998)
Deze afstanden zijn dus wel ok, maar het label van het telpunt moet aangepast worden.

**Oostelijke leemstreek**

In de Oostelijke leemstreek gaat het om `r outlying_distances %>% filter(regio == "Oostelijke leemstreek") %>% distinct(plotnaam) %>% pull() %>% length()` punten in `r outlying_distances %>% filter(regio == "Oostelijke leemstreek") %>% distinct(jaar) %>% pull() %>% length()` jaren in `r outlying_distances %>% filter(regio == "Oostelijke leemstreek") %>% distinct(periode_in_jaar) %>% pull() %>% length()` telperiodes.

Zijn het telkens dezelfde punten die problemen geven?

```{r}
# Count per location
outlying_distances %>%
  filter(regio == "Oostelijke leemstreek") %>%
  group_by(plotnaam) %>%
  summarise(n_jaren = n_distinct(jaar),
            n_periodes = n_distinct(jaar, periode_in_jaar)) %>%
  arrange(n_jaren, n_periodes) %>%
  kable()
```

In sommige gevallen wel.
Het gaat telkens om oude punten.

```{r}
# Data preparation
years <- outlying_dist_obs %>%
  filter(regio == "Oostelijke leemstreek") %>%
  distinct(jaar) %>%
  pull()

# Create an empty leaflet map
leaflet_map <- leaflet() %>%
  addTiles()

# Loop through each year and round, adding layers to the map
for (j in sort(years)) {
  periods <- outlying_dist_obs %>%
    filter(regio == "Oostelijke leemstreek",
           jaar == j) %>%
    distinct(periode_in_jaar) %>%
    pull()

  for (ronde in sort(periods)) {
    # Filter data for the current year and round
    circles <- outlying_dist_circles %>%
      filter(regio == "Oostelijke leemstreek",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    plots <- outlying_dist_plots %>%
      filter(regio == "Oostelijke leemstreek",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    observations <- outlying_dist_obs %>%
      filter(regio == "Oostelijke leemstreek",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)

    # Create title
    title <- paste("Jaar:", j, "- Ronde:", ronde)

    # Add the layers to the leaflet map with group names
    leaflet_map <- leaflet_map %>%
      addPolygons(data = circles, fillOpacity = 0.3, group = title) %>%
      addCircleMarkers(data = plots, radius = 3, color = "black",
                       group = title, label = ~plots$plotnaam) %>%
      addCircleMarkers(data = observations, fillOpacity = 0.8, radius = 5,
                       color = "red",
                       group = title, label = ~observations$abs_diff)
  }
}

# Calculate control groups
groups <- outlying_dist_obs %>%
  filter(regio == "Oostelijke leemstreek") %>%
  distinct(jaar, periode_in_jaar) %>%
  mutate(group = paste("Jaar:", jaar, "- Ronde:", periode_in_jaar)) %>%
  pull(group)

# Add layer control to toggle visibility of the facets
leaflet_map <- leaflet_map %>%
  addLayersControl(
    overlayGroups = groups,
    options = layersControlOptions(collapsed = FALSE)
  )

# Print the leaflet map
leaflet_map
```

> Locaties niet juist??

## Selecteer data binnen telcirkel radius (select_within_radius)

We selecteren data binnen de telcirkels.
Telcirkels hebben een radius van 300 m.
De afstanden krijgen we mee van Sovon, maar worden herberekend.

Verliezen we data indien we filteren binnen deze radius?
Indien ja, hoeveel en waar?

```{r}
select_within_radius <- tar_read_sf(
  "select_within_radius", store = targets_store)
```

In totaal vallen `r nrow(calculate_obs_distance) - nrow(select_within_radius)` waarnemingen buiten de telcirkels.

```{r}
# Calculate difference in number of observations before and after filtering on
# radius
obs_per_year <- select_time_periods %>%
  st_drop_geometry() %>%
  count(regio, jaar)

obs_per_year_filtered <- select_within_radius %>%
  st_drop_geometry() %>%
  count(regio, jaar, name = "n_filtered")

obs_per_year %>%
  full_join(obs_per_year_filtered, by = join_by(regio, jaar)) %>%
  mutate(difference = n - n_filtered) %>%
  kable()
```

Het gaat om veel waarnemingen.
We visualiseren deze.

```{r}
# Calculate percentage of outlying observations per location and date
outside_observations <- calculate_obs_distance %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar) %>%
  mutate(max_dist = max(distance2plot)) %>%
  ungroup() %>%
  filter(max_dist > 300) %>%
  mutate(outlier = ifelse(distance2plot > 300, "buiten", "binnen")) %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar) %>%
  mutate(outlier_perc = sum(grepl("buiten", outlier)) / n()) %>%
  ungroup() %>%
  select(regio, plotnaam, jaar, periode_in_jaar, distance2plot,
         outlier, outlier_perc, x_coord, y_coord)

# Get problematic point locations
outside_plots <- outside_observations %>%
  st_drop_geometry() %>%
  distinct(regio, plotnaam, jaar, periode_in_jaar, x_coord, y_coord) %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 31370)

# Get problematic location circles
outside_circles <- outside_plots %>%
  st_buffer(300)

# Visualise outlier percentage distribution
for (reg in sort(unique(outside_observations$regio))) {
  p <- outside_observations %>%
      filter(regio == reg) %>%
      distinct(regio, plotnaam, jaar, periode_in_jaar, outlier_perc) %>%
      ggplot() +
        geom_histogram(aes(x = outlier_perc), bins = 20) +
        coord_cartesian(xlim = c(0, 1)) +
        labs(x = "Procent waarnemingen buiten telcirkel per telling",
             y = "Frequentie",
             title = reg) +
        facet_wrap(~jaar, ncol = 3)
  print(p)
}
```

We stellen dat een verwijdering van > 20% van de waarnemingen per telling op een probleem kan wijzen.
We filteren hierop en kijken wat overblijft.

```{r}
# Filter problematic observations, point locations and circles on outlying
# percentage
outside_observations_new <- outside_observations %>%
  filter(outlier_perc > 0.2)

outside_plots_new <- outside_observations_new %>%
  st_drop_geometry() %>%
  distinct(regio, plotnaam, jaar, periode_in_jaar, x_coord, y_coord) %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 31370)

outside_circles_new <- outside_plots_new %>%
  st_buffer(300)
```

Vooral in de Oostelijke leemstreek en de Polders zijn er verdachte cases.

**Kempen, Weidestreek, Westelijke leemstreek, Zandleemstreek, Zandstreek**

We controleren eerst alle andere regio's (per jaar per telronde).

```{r}
# Data preparation
years <- outside_observations_new %>%
  filter(regio != "Oostelijke leemstreek",
         regio != "Polders") %>%
  distinct(jaar) %>%
  pull()

# Create an empty leaflet map
leaflet_map <- leaflet() %>%
  addTiles()

# Loop through each year and round, adding layers to the map
for (j in sort(years)) {
  periods <- outside_observations_new %>%
    filter(regio != "Oostelijke leemstreek",
         regio != "Polders",
         jaar == j) %>%
    distinct(periode_in_jaar) %>%
    pull()

  for (ronde in sort(periods)) {
    # Filter data for the current year and round
    circles <- outside_circles_new %>%
      filter(regio != "Oostelijke leemstreek",
             regio != "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    plots <- outside_plots_new %>%
            filter(regio != "Oostelijke leemstreek",
             regio != "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    observations <- outside_observations_new %>%
            filter(regio != "Oostelijke leemstreek",
             regio != "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)

    # Create title
    title <- paste("Jaar:", j, "- Ronde:", ronde)

    # Add the layers to the leaflet map with group names
    leaflet_map <- leaflet_map %>%
      addPolygons(data = circles, fillOpacity = 0.3, group = title) %>%
      addCircleMarkers(data = plots, radius = 3, color = "black",
                       group = title, label = ~plots$plotnaam) %>%
      addCircleMarkers(data = observations, fillOpacity = 0.8, radius = 5,
                       color = ~ifelse(outlier == "binnen", "green", "red"),
                       group = title, label = ~observations$plotnaam)
  }
}

# Calculate control groups
groups <- outside_observations_new %>%
  filter(regio != "Oostelijke leemstreek",
         regio != "Polders") %>%
  distinct(jaar, periode_in_jaar) %>%
  mutate(group = paste("Jaar:", jaar, "- Ronde:", periode_in_jaar)) %>%
  pull(group)

# Add layer control to toggle visibility of the facets
leaflet_map <- leaflet_map %>%
  addLayersControl(
    overlayGroups = groups,
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("green", "red"),
    labels = c("binnen", "buiten"),
    title = "Locatie t.o.v. telcirkel")

# Print the leaflet map
leaflet_map
```

Deze lijken allemaal ok.
Slechts enkele waarnemingen die buiten de telcirkel vallen.
Deze mogen worden weggefilterd.

**Polders**

In de Polders liggen er maximaal `r round(max(outside_observations %>% filter(regio == "Polders") %>% pull(outlier_perc)), 2)` procent waarnemingen buiten de telcirkel per telling.

```{r}
# Data preparation
years <- outside_observations_new %>%
  filter(regio == "Polders") %>%
  distinct(jaar) %>%
  pull()

# Create an empty leaflet map
leaflet_map <- leaflet() %>%
  addTiles()

# Loop through each year and round, adding layers to the map
for (j in sort(years)) {
  periods <- outside_observations_new %>%
    filter(regio == "Polders",
           jaar == j) %>%
    distinct(periode_in_jaar) %>%
    pull()

  for (ronde in sort(periods)) {
    # Filter data for the current year and round
    circles <- outside_circles_new %>%
      filter(regio == "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    plots <- outside_plots_new %>%
      filter(regio == "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    observations <- outside_observations_new %>%
      filter(regio == "Polders",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)

    # Create title
    title <- paste("Jaar:", j, "- Ronde:", ronde)

    # Add the layers to the leaflet map with group names
    leaflet_map <- leaflet_map %>%
      addPolygons(data = circles, fillOpacity = 0.3, group = title) %>%
      addCircleMarkers(data = plots, radius = 3, color = "black",
                       group = title, label = ~plots$plotnaam) %>%
      addCircleMarkers(data = observations, fillOpacity = 0.8, radius = 5,
                       color = ~ifelse(outlier == "binnen", "green", "red"),
                       group = title, label = ~observations$plotnaam)
  }
}

# Calculate control groups
groups <- outside_observations_new %>%
  filter(regio == "Polders") %>%
  distinct(jaar, periode_in_jaar) %>%
  mutate(group = paste("Jaar:", jaar, "- Ronde:", periode_in_jaar)) %>%
  pull(group)

# Add layer control to toggle visibility of the facets
leaflet_map <- leaflet_map %>%
  addLayersControl(
    overlayGroups = groups,
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("green", "red"),
    labels = c("binnen", "buiten"),
    title = "Locatie t.o.v. telcirkel")

# Print the leaflet map
leaflet_map
```

We zien een problematisch punt in 2024: Pl_49572.
Alle andere lijken ok.

```{r}
# Show outlying percentage of Pl_49572
outside_observations_new %>%
  st_drop_geometry() %>%
  filter(plotnaam == "Pl_49572") %>%
  count(plotnaam, jaar, periode_in_jaar, outlier_perc, outlier) %>%
  kable()
```

Het ziet ernaar uit dat Pl_49572 dezelfde naam heeft voor 2 locaties.
In plaats van: Pl_25053.16 (x: 50279.09, y: 210998)

**Oostelijke leemstreek**

```{r}
# Data preparation
years <- outside_observations_new %>%
  filter(regio == "Oostelijke leemstreek") %>%
  distinct(jaar) %>%
  pull()

# Create an empty leaflet map
leaflet_map <- leaflet() %>%
  addTiles()

# Loop through each year and round, adding layers to the map
for (j in sort(years)) {
  periods <- outside_observations_new %>%
    filter(regio == "Oostelijke leemstreek",
           jaar == j) %>%
    distinct(periode_in_jaar) %>%
    pull()

  for (ronde in sort(periods)) {
    # Filter data for the current year and round
    circles <- outside_circles_new %>%
      filter(regio == "Oostelijke leemstreek",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    plots <- outside_plots_new %>%
      filter(regio == "Oostelijke leemstreek",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)
    observations <- outside_observations_new %>%
      filter(regio == "Oostelijke leemstreek",
             jaar == j,
             periode_in_jaar == ronde) %>%
      st_transform(4326)

    # Create title
    title <- paste("Jaar:", j, "- Ronde:", ronde)

    # Add the layers to the leaflet map with group names
    leaflet_map <- leaflet_map %>%
      addPolygons(data = circles, fillOpacity = 0.3, group = title) %>%
      addCircleMarkers(data = plots, radius = 3, color = "black",
                       group = title, label = ~plots$plotnaam) %>%
      addCircleMarkers(data = observations, fillOpacity = 0.8, radius = 5,
                       color = ~ifelse(outlier == "binnen", "green", "red"),
                       group = title, label = ~observations$plotnaam)
  }
}

# Calculate control groups
groups <- outside_observations_new %>%
  filter(regio == "Oostelijke leemstreek") %>%
  distinct(jaar, periode_in_jaar) %>%
  mutate(group = paste("Jaar:", jaar, "- Ronde:", periode_in_jaar)) %>%
  pull(group)

# Add layer control to toggle visibility of the facets
leaflet_map <- leaflet_map %>%
  addLayersControl(
    overlayGroups = groups,
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("green", "red"),
    labels = c("binnen", "buiten"),
    title = "Locatie t.o.v. telcirkel")

# Print the leaflet map
leaflet_map
```

Deze probleempunten zijn allicht gerelateerd aan de locaties van de telpunten, zoals opgemerkt in de vorige subsectie.

## Selecteer soortengroepen (select_species_groups)

Vervolgens selecteren we de data van vogels (soortgrp 2) en zoogdieren (soortgrp 1).

```{r}
select_species_groups <- tar_read_sf(
  "select_species_groups", store = targets_store)
```

Is het aantal soortgroepen in de data gelijk aan 2?

```{r}
# Get number of species groups
n_soortgroups <- select_species_groups %>%
  st_drop_geometry() %>%
  distinct(soortgrp) %>%
  nrow()

# Equal to 2 (birds and mammals)?
n_soortgroups == 2
```

Ok.

## Verwerk dubbeltellingen (remove_double_counts)

Sommige telpunten zijn 2x geteld.
We selecteren de telling van de laatste dag binnen de telperiode of de telling gedaan door een professionele teller indien van toepassing.

```{r, echo=FALSE}
# Create table to show professional counters
profs      <-  c("WVNT00", # professional from the start
                 "JJNN16",
                 "NOVN00",
                 "ETBX00")
profs_2022 <-    "RPLT02" # professional after 2022
profs_2023 <- c("KLMS02", # professional after 2023
                "KLMS02",
                "ETON01",
                "BDMR00",
                "DDMR00",
                "PADS02",
                "PCAS00",
                "BOPE01")
profs_2024 <- c("KLMS02", # professional after 2024
                "ETON01",
                "BDMR00",
                "DDMR00",
                "BOPE01",
                "DDMR01",
                "AIST00",
                "MJCS03",
                "TGSS02",
                "WVNN05",
                "BBMS01",
                "WKPN01",
                "RDLK00",
                "ABNS05",
                "IJCS01",
                "DVRN00",
                "JPNS04",
                "LBRH01",
                "RLJE00",
                "ETBX00",
                "LHNN03",
                "SDST00")

data.frame(
    professional = c(
      profs,
      profs_2022,
      profs_2023,
      profs_2024
    ),
    sinds = c(
      rep("vanaf start", length(profs)),
      rep("vanaf 2022", length(profs_2022)),
      rep("vanaf 2023", length(profs_2023)),
      rep("vanaf 2024", length(profs_2024))
    )
  ) %>%
  kable()
```

```{r}
remove_double_counts <- tar_read_sf(
  "remove_double_counts", store = targets_store)
```

We lijsten op waar dubbeltellingen zijn verwijderd.

```{r}
# Get locations with removed observations due to double counting
removed_obs <- select_species_groups %>%
  st_drop_geometry() %>%
  anti_join(st_drop_geometry(remove_double_counts),
            by = join_by(oid, projectid, plotid, plotnaam, x_amersfoord,
                         y_amersfoord, x_lambert, y_lambert, soortgrp, soortnr,
                         naam, aantal, jaar, maand, dag, doy, wrntype,
                         broedcode, opmerk, clterr, clterrid, inplot, periodeid,
                         periode, wrntype_omschrijving, sample_order, batch,
                         regio, area_prop_sb, openheid_klasse, sbp, x_coord,
                         y_coord, crs, datum, periode_in_jaar, distance2plot))

removed_obs %>%
  group_by(regio, plotnaam, jaar) %>%
  summarise(n_periodes = n_distinct(jaar, periode_in_jaar),
            .groups = "drop") %>%
  arrange(regio, plotnaam, jaar) %>%
  kable()
```

Zijn alle dubbeltellingen verwijderd?
In de verwerkte data zou elke locatie maar 1x geteld moeten zijn per periode en jaar.

```{r}
# Calculate number of counts in processed data
select_species_groups %>%
  st_drop_geometry() %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  distinct(regio, plotnaam, jaar, periode_in_jaar, datum) %>%
  count(regio, plotnaam, jaar, periode_in_jaar,
        name = "n_tellingen") %>%
  filter(n_tellingen > 1) %>%
  arrange(regio, plotnaam, jaar) %>%
  kable()
```

|Oostelijke leemstreek |VL0289      | 2020|R3              |           2|

|Oostelijke leemstreek |VL0330      | 2021|R2              |           2|

```{r}
remove_double_counts %>%
  st_drop_geometry() %>%
  filter(plotnaam == "VL0289", jaar == 2020, periode_in_jaar == "R3") %>%
  View()

remove_double_counts %>%
  st_drop_geometry() %>%
  filter(plotnaam == "VL0330", jaar == 2021, periode_in_jaar == "R2") %>%
  View()
```

> probleem verschillende datums maar beide proffessionele teller!

**Polders**

Zijn de juiste tellingen verwijderd?

```{r}
# Which locations are removed?
removed_obs_pl <- removed_obs %>%
  filter(regio == "Polders") %>%
  distinct(plotnaam, regio, jaar, periode_in_jaar)

# Which observations are removed per date?
removed_obs_pl2 <- removed_obs %>%
  filter(regio == "Polders") %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  distinct(plotnaam, regio, datum, periode_in_jaar) %>%
  mutate(keep = FALSE)

# Get double counts and look if correct ones are removed
select_species_groups %>%
  st_drop_geometry() %>%
  inner_join(removed_obs_pl,
             by = join_by(plotnaam, jaar, regio, periode_in_jaar)) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  # Add variable keep
  full_join(removed_obs_pl2,
            by = join_by(plotnaam, regio, datum, periode_in_jaar)) %>%
  mutate(keep = is.na(keep)) %>%
  count(plotnaam, datum, periode_in_jaar, waarnemer = waarneme, keep,
        name = "n_obs") %>%
  arrange(plotnaam, periode_in_jaar, datum) %>%
  kable()
```

Laatste telling behouden, ok.

**Oostelijke leemstreek**

Zijn de juiste tellingen verwijderd?

```{r}
# Which locations are removed?
removed_obs_ol <- removed_obs %>%
  filter(regio == "Oostelijke leemstreek") %>%
  distinct(plotnaam, regio, jaar, periode_in_jaar)

# Which observations are removed per date?
removed_obs_ol2 <- removed_obs %>%
  filter(regio == "Oostelijke leemstreek") %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  distinct(plotnaam, regio, datum, periode_in_jaar) %>%
  mutate(keep = FALSE)

# Get double counts and look if correct ones are removed
select_species_groups %>%
  st_drop_geometry() %>%
  inner_join(removed_obs_ol,
             by = join_by(plotnaam, jaar, regio, periode_in_jaar)) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  full_join(removed_obs_ol2,
            by = join_by(plotnaam, regio, datum, periode_in_jaar)) %>%
  mutate(keep = is.na(keep)) %>%
  count(plotnaam, datum, periode_in_jaar, waarnemer = waarneme, keep,
        name = "n_obs") %>%
  arrange(plotnaam, datum, periode_in_jaar) %>%
  kable()
```

- Ol_12609.15, 2022, R1, LEVS01: ok, laatste telling
- VL0055, 2019, R1-R4, JJNN16: ok, prof
- VL0351, 2019, R2, FVRT02: ok, laatste telling
- VL0587, 2021, R3, BSCX00: ok, laatste telling
- VL0587, 2024, R2, BSCX00: ok, laatste telling
- VL0590, 2021, R3, BSCX00: ok, laatste telling
- VL0590, 2024, R2, BSCX00: ok, laatste telling

## Verwerk namen van ondersoorten (remove_subspecies_names)

De volgende ondersoorten worden aangepast tot op soortniveau.

```{r, echo=FALSE}
# Create table to show subspecies
data.frame(
    ondersoort = c(
      "gele kwikstaart (spec)",
      "engelse kwikstaart",
      "witte kwikstaart (spec)",
      "Rouwkwikstaart",
      "canadese gans spec.",
      "Witsterblauwborst"
    ),
    soort = c(
      rep("Gele kwikstaart", 2),
      rep("Witte kwikstaart", 2),
      rep("Grote Canadese Gans", 1),
      rep("Blauwborst", 1)
    )
  ) %>%
  kable()
```

## Voeg predatorvariabele toe (add_predator_variable)

We voegen een variabele toe aan de data met per observatie of het een predator is of niet.
Ook worden het aantal predatoren per telling berekend.
Kraaiachtigen en roofvogels vormen samen de predatoren.

Voor kraaiachtigen hebben we:

```{r}
kraaiachtigen_f()
```

Voor roofvogels hebben we:

```{r}
roofvogels_f()
```

## Telpunten in finale dataset (mas_data_full)

```{r}
mas_data_full <- tar_read("mas_data_full", store = targets_store)
```

Zijn alle punten zijn nog altijd aanwezig?

```{r}
# Show number of locations per stratum
mas_data_full %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, openheid_klasse, sbp) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

Ja.

# Controle finale dataset

...

> zie werkwijze pilootproject

# Controle data publicatie

...
