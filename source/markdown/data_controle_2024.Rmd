---
title: "Controle data en data preparatie pipeline"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# packages
library(tidyverse)
library(sf)
library(mapview)
library(targets)

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Source
source(here::here("source", "R", "tar_read_sf.R"))

# Paths
mbag_dir <- here::here()
targets_store <- here::here("source", "targets", "data_preparation", "_targets")
```

# Doel

Data preparatie verloopt via een targets pipeline waarbij verschillende stappen elkaar opvolgen.

```{r}
tar_visnetwork(script = paste0(targets_store, ".R"),
               store = targets_store)
```

In deze markdown controleren we 

1. Of deze pipeline de verwachte stappen correct doorloopt
2. De finale data op het einde van de pipeline voor onverwachte zaken, uitschieters ...

We doen dit voor de data van 2018-2024.

# Data preparatie pipeline
## Amersfoord naar Lambert coördinaten (crs_pipeline)

In de eerste stap worden Amersfoord coördinaten naar Lambert coördinaten omgezet.
Dit gebeurt via een functie die op verschillende datasets goed getest is.

## Selectie punten MBAG steekproefkader (select_sampled_points)

In de tweede stap selecteren we de punten uit de totale dataset die tot het MBAG steekproefkader behoren.
Dit gebeurt via een "inner join" wat wil zeggen dat we kunnen nagaan of telpunten uit het steekproefkader niet bezocht zijn (bewust of onbewust).

```{r}
sample <- tar_read("sample", store = targets_store)

select_sampled_points <- tar_read_sf("select_sampled_points",
                                     store = targets_store)
```

Welke aantallen hebben we per stratum?

```{r}
sample %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

We kijken of we dezelfde aantallen vinden in de data.

```{r}
sample_visited <- select_sampled_points %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, openheid_klasse, sbp)

sample_visited %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

Er waren 201 telpunten in het steekproefkader, maar er zijn er 199 geteld.
Welke punten zijn niet geteld?

```{r}
setdiff(sample$pointid, sample_visited$plotnaam)
```

> Nagaan of deze bewust of onbewust niet geteld zijn

Notities manuele controle Johannes:

- Pl_25053.16: plek zelf moeilijk te gaan staan stoppen aan overkant weg wel
- Pl_45612.2: OK geen privé weg maar langs bedrijf

### Selecteer data binnen de telperiodes (select_time_periods)

We selecteren data binnen de correcte telperiodes.
Er zijn 4 telrondes:

- R1: 1 april - 20 april
- R2: 21 april - 10 mei
- R3: 11 mei - 10 juni
- R4: 21 juni - 15 juli

Verliezen we data indien we filteren binnen deze periodes?
Indien ja, hoeveel en waar?

```{r}
select_time_periods <- tar_read_sf("select_time_periods", store = targets_store)
```

In totaal vallen `r nrow(select_sampled_points) - nrow(select_time_periods)` waarnemingen buiten de telperiodes.

```{r}
obs_per_year <- select_sampled_points %>%
  st_drop_geometry() %>%
  count(regio, jaar)

obs_per_year_filtered <- select_time_periods %>%
  st_drop_geometry() %>%
  count(regio, jaar, name = "n_filtered")

obs_per_year %>%
  full_join(obs_per_year_filtered, by = join_by(regio, jaar)) %>%
  mutate(difference = n - n_filtered) %>%
  kable()
```

- Kempen
  - ok
- Oostelijke leemstreek
  - verschil alleen voor pre-MBAG jaren (2018-2022), ok
- Polders:
  - verschil alleen voor pre-MBAG jaren (2022-2023), ok
  - 2024 nakijken!
- Westelijke leemstreek
  - 2024 nakijken!
- Zandleemstreek
  - 2024 nakijken!
- Zandstreek:
  - verschil pre-MBAG jaren (2022-2023), ok
  - 2024 nakijken!

**Polders**

```{r}
oid_pl <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Polders", jaar == 2024) %>%
    pull(oid)

oid_pl_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Polders", jaar == 2024) %>%
    pull(oid)

oid_pl_diff <- setdiff(oid_pl, oid_pl_filtered)

obs_per_date_pl <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Polders",
         jaar == 2024,
         oid %in% oid_pl_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_pl %>%
  kable()
```

Dit zijn wintertellingen, dus is ok.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
obs_per_period_pl <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Polders",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_pl$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_pl %>%
  kable()
```

Beerpolder is niet geteld in ronde 1.

**Westelijke leemstreek**

```{r}
oid_wlm <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Westelijke leemstreek", jaar == 2024) %>%
    pull(oid)

oid_wlm_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Westelijke leemstreek", jaar == 2024) %>%
    pull(oid)

oid_wlm_diff <- setdiff(oid_wlm, oid_wlm_filtered)

obs_per_date_wlm <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Westelijke leemstreek",
         jaar == 2024,
         oid %in% oid_wlm_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_wlm %>%
  kable()
```

Deze punten zijn geteld tussen telrondes 3 en 4.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
obs_per_period_wlm <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Westelijke leemstreek",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_wlm$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_wlm %>%
  kable()
```

Neen, deze locaties zijn niet in telperiode 4 geteld.

**Zandleemstreek**

```{r}
oid_zlm <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Zandleemstreek", jaar == 2024) %>%
    pull(oid)

oid_zlm_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Zandleemstreek", jaar == 2024) %>%
    pull(oid)

oid_zlm_diff <- setdiff(oid_zlm, oid_zlm_filtered)

obs_per_date_zlm <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Zandleemstreek",
         jaar == 2024,
         oid %in% oid_zlm_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_zlm %>%
  kable()
```

Deze punten zijn geteld tussen telrondes 3 en 4.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
obs_per_period_zlm <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Zandleemstreek",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_zlm$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_zlm %>%
  kable()
```

Neen, deze locaties zijn niet in telperiode 4 geteld.

**Zandstreek**

```{r}
oid_za <- select_sampled_points %>%
    st_drop_geometry() %>%
    filter(regio == "Zandstreek", jaar == 2024) %>%
    pull(oid)

oid_za_filtered <- select_time_periods %>%
    st_drop_geometry() %>%
    filter(regio == "Zandstreek", jaar == 2024) %>%
    pull(oid)

oid_za_diff <- setdiff(oid_za, oid_za_filtered)

obs_per_date_za <- select_sampled_points %>%
  st_drop_geometry() %>%
  filter(regio == "Zandstreek",
         jaar == 2024,
         oid %in% oid_za_diff) %>%
  mutate(datum = ymd(paste(jaar, maand, dag, sep = "-"))) %>%
  count(plotnaam, datum, name = "n_obs") %>%
  arrange(plotnaam, datum)

obs_per_date_za %>%
  kable()
```

Dit zijn wintertellingen, dus is ok.
Worden deze punten wel ook nog geteld in de correcte periodes?

```{r}
obs_per_period_za <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(regio == "Zandstreek",
         jaar == 2024,
         plotnaam %in% unique(obs_per_date_za$plotnaam)) %>%
  count(plotnaam, periode_in_jaar, naam = "n_obs") %>%
  group_by(plotnaam) %>%
  mutate(n_periodes = n_distinct(periode_in_jaar)) %>%
  ungroup()

obs_per_period_za %>%
  kable()
```

ok.

We schrijven deze data weg zodat ze gecontroleerd kunnen worden.

```{r}
locs_outside_periods <- bind_rows(
  obs_per_period_pl,
  obs_per_period_wlm,
  obs_per_period_zlm,
  obs_per_period_za
  ) %>%
  filter(n_periodes < 4) %>%
  distinct(plotnaam) %>%
  pull()

delete_from_df <- select_time_periods %>%
  st_drop_geometry() %>%
  filter(jaar == 2024,
         plotnaam %in% locs_outside_periods) %>%
  distinct(plotnaam, jaar, maand, dag, waarnemer = waarneme)

select_sampled_points %>%
  st_drop_geometry() %>%
  filter(jaar == 2024,
         plotnaam %in% locs_outside_periods) %>%
  distinct(plotnaam, jaar, maand, dag, waarnemer = waarneme) %>%
  anti_join(delete_from_df,
            by = join_by(plotnaam, jaar, maand, dag, waarnemer)) %>%
  write_csv(file.path(mbag_dir, "output", "data_controle",
                      "tellingen_buiten_telrondes.csv"))
```

### Selecteer data binnen telcirkel radius (select_within_radius)

...

### Selecteer soortengroepen (select_species_groups)

...

### Verwerk dubbeltellingen (remove_double_counts)

...

### Verwerk namen van ondersoorten (remove_subspecies_names)

...

### Voeg predatorvariabele toe (add_predator_variable)

...

### Telpunten in finale dataset (mas_data_full)

```{r}
mas_data_full <- tar_read("mas_data_full", store = targets_store)
```

Zijn alle punten zijn nog altijd aanwezig?

```{r}
mas_data_full %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, openheid_klasse, sbp) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  count(regio, stratum, name = "n_stratum") %>%
  group_by(regio) %>%
  mutate(n_regio = sum(n_stratum)) %>%
  ungroup() %>%
  kable()
```

Ja.

# Controle finale dataset

*zie werkwijze pilootproject*

```{r}
mas_data_clean <- tar_read("mas_data_clean", store = targets_store)
```

```{r}
count_per_period <- mas_data_clean %>%
  st_drop_geometry() %>%
  distinct(plotnaam, regio, periode_in_jaar, jaar) %>%
  count(regio, periode_in_jaar, jaar, name = "n_period")

for (reg in sort(unique(count_per_period$regio))) {
  p <- count_per_period %>%
    filter(regio == reg) %>%
    ggplot(aes(x = periode_in_jaar, y = n_period)) +
      geom_bar(stat = "identity") +
      geom_text(aes(label = n_period),
        position = position_dodge(width = 0.9), vjust = -0.25
      ) +
      facet_grid(rows = vars(regio), cols = vars(jaar)) +
      labs(x = "Telperiode", y = "Aantal telpunten")
  print(p)
}
```
