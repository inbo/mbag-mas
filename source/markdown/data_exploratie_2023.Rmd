---
title: "Exploratie uitbreiding MAS 2023"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())

Sys.setenv("PROJ_NETWORK" = "ON")
```

```{r}
# packages
library(tidyverse)
library(INBOtheme)
library(sf)

theme_set(theme_inbo(transparent = TRUE))

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::lag)

# Paths
data_path <- here("data", "mas")
media_folder <- here("media", "exploratie_2023")
dir.create(media_folder, showWarnings = FALSE)

devices <- c("pdf", "png")

# Source
source(here("source", "R", "roofvogels_f.R"))
source(here("source", "R", "save_figure.R"))
```

# Doel

Exploratie gegevens Zandleemstreek en Westelijke leemstreek 2023 voor eerste rapport MBAG.


# Inlezen data

```{r}
file_geojson_2023 <- file.path(
  data_path,
  "20230810_qgis_export_sovon_wfs_2023.geojson"
)
mas_geojson_2023 <- read_sf(file_geojson_2023)
```

We moeten een reeks selecties en data preparatiestappen doen.
In een later stadium worden deze best in een analysepijplijn (bv. targets) gegoten.

## CRS

De CRS moet aangepast worden van Amersfoort naar Lambert 72. Dit doen we via een specifieke pipeline, zie: https://inbo.github.io/tutorials/tutorials/spatial_transform_crs_2/

```{r}
pipelines <- sf_proj_pipelines("EPSG:28992", "EPSG:31370")
glimpse(pipelines)
```

```{r}
# We select the pipeline with lowest accuracy (< 0.02), by filtering on accuracy.
# If the grids are installed, this should match the first line of the pipelines object.
chosen_pipeline_definition <- pipelines %>%
  filter(accuracy < 0.02) %>%
  pull(definition)

mas_31370_pipeline <-
  st_transform(st_geometry(mas_geojson_2023), "EPSG:31370",
    pipeline = chosen_pipeline_definition
  ) %>%
  st_sf(st_drop_geometry(mas_geojson_2023), geometry = .) %>%
  as_tibble() %>%
  st_as_sf() %>%
  rename(
    x_amersfoord = x_coord,
    y_amersfoord = y_coord
  ) %>%
  mutate(
    x_lambert = unlist(map(.data$geometry, 1)),
    y_lambert = unlist(map(.data$geometry, 2))
  ) %>%
  select(oid:y_amersfoord, x_lambert, y_lambert, everything())
```

## Data selectie
### Landbouwstreken

We selecteren de data van de Zandleemstreek en de Westelijke leemstreek.
Dit doen we door te joinen met de steekproef.

```{r}
steekproef_avimap_piloot <- read_csv(here(
  "data", "steekproefkaders",
  "steekproef_avimap_mbag_piloot.csv"
))

mas_data_regios <- mas_31370_pipeline %>%
  inner_join(steekproef_avimap_piloot, by = join_by(plotnaam == pointid))
```

### Telrondes

We selecteren dan de MAS-data binnen de telrondes.

```{r}
r1_start <- "04-01"
r1_stop <- "04-20"
r2_start <- "04-21"
r2_stop <- "05-10"
r3_start <- "05-11"
r3_stop <- "06-10"
r4_start <- "06-21"
r4_stop <- "07-15"

mas_telperiodes <- mas_data_regios %>%
  mutate(
    datum = ymd(paste(jaar, maand, dag, sep = "-")),
    periode_in_jaar = case_when(
      datum %within% interval(
        ymd(paste(jaar, r1_start, sep = "-")),
        ymd(paste(jaar, r1_stop, sep = "-"))
      ) ~ "R1",
      datum %within% interval(
        ymd(paste(jaar, r2_start, sep = "-")),
        ymd(paste(jaar, r2_stop, sep = "-"))
      ) ~ "R2",
      datum %within% interval(
        ymd(paste(jaar, r3_start, sep = "-")),
        ymd(paste(jaar, r3_stop, sep = "-"))
      ) ~ "R3",
      datum %within% interval(
        ymd(paste(jaar, r4_start, sep = "-")),
        ymd(paste(jaar, r4_stop, sep = "-"))
      ) ~ "R4"
    )
  ) %>%
  filter(!is.na(periode_in_jaar))
```

### Telcirkel

We herberekenen de afstanden tussen de waarnemingen en de telpunten. We ronden af to 1 m nauwkeurig.

```{r}
steekproef_avimap_piloot_sf <- steekproef_avimap_piloot %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 31370) %>%
  select(plotnaam = pointid, regio, geometry)

mas_controle_afstand <- mas_telperiodes %>%
  select(oid, plotnaam, distance2plot, naam, jaar, waarnemer = waarneme) %>%
  inner_join(steekproef_avimap_piloot_sf %>% as_tibble(),
    by = c("plotnaam"), suffix = c(".stip", ".telpunt")
  ) %>%
  mutate(
    calc_distance = st_distance(.$geometry.stip, .$geometry.telpunt,
      by_element = TRUE
    ),
    calc_distance = round(units::drop_units(calc_distance))
  ) %>%
  st_drop_geometry()
```

We selecteren vervolgens alle waarnemingen binnen een afstand van 300 m.

```{r}
test_dist_df <- mas_telperiodes %>%
  full_join(mas_controle_afstand,
    by = join_by(oid, plotnaam, naam, jaar, distance2plot, regio)
  ) %>%
  select(-c(distance2plot, geometry.telpunt, waarneme)) %>%
  rename(distance2plot = calc_distance) %>%
  st_drop_geometry() %>%
  mutate(test_var = distance2plot > 300) %>%
  group_by(regio, plotnaam, periode_in_jaar) %>%
  summarise(
    afval_n = sum(test_var),
    aantal_waarnemingen = n(),
    afval_prop = sum(test_var) / n()
  ) %>%
  ungroup()
```

Over het algemeen vallen er weinig waarnemingen weg.

```{r}
test_dist_df %>%
  ggplot() +
  geom_bar(aes(x = afval_n)) +
  labs(
    x = "Aantal waarnemingen die wegvallen per telpunt per telperiode",
    y = "Frequentie"
  )
```

In sommige gevallen valt wel een grote proportie van het aantal waarnemingen weg per telling (nullen weggelaten).

```{r}
test_dist_df %>%
  filter(afval_prop > 0) %>%
  ggplot() +
  geom_histogram(aes(x = afval_prop)) +
  scale_y_continuous(breaks = seq(0, 100, 5)) +
  labs(
    x = paste("Proportie aantal waarnemingen die wegvallen",
      "per telpunt per telperiode",
      sep = "\n"
    ),
    y = "Frequentie"
  )
```

Deze gevallen moeten misschien apart bekeken worden.
Hier de tellingen waarbij minstens 50 % van de waarnemingen buiten de telcirkel (afstand > 300 m).

```{r}
test_dist_df %>%
  filter(afval_prop >= 0.5) %>%
  arrange(afval_prop) %>%
  kable(digits = 3)
```

```{r}
mas_distance <- mas_telperiodes %>%
  full_join(mas_controle_afstand,
    by = join_by(oid, plotnaam, naam, jaar, distance2plot, regio)
  ) %>%
  select(-c(distance2plot, geometry.telpunt, waarneme)) %>%
  rename(distance2plot = calc_distance) %>%
  filter(distance2plot <= 300)
```

De afstanden van de waarnemingen tot het middelpunt zijn correct:

```{r}
detail <- c(
  "xmin" = 193500,
  "ymin" = 179000,
  "xmax" = 201000,
  "ymax" = 185000
)

detail_sf <- tibble(geometry = st_as_sfc(st_bbox(detail))) %>%
  st_as_sf() %>%
  st_set_crs(31370)

mapview::mapview(st_crop(steekproef_avimap_piloot_sf, detail_sf),
  legend = FALSE
) +
  mapview::mapview(
    st_crop(
      st_buffer(mas_distance, mas_distance$distance2plot),
      detail_sf
    ),
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview::mapview(detail_sf, alpha.regions = 0)
```

### Zoogdieren en vogels

```{r}
mas_soortgrp <- mas_distance %>%
  filter(soortgrp %in% 1:2)
```

## Dubbeltellingen

Er zijn geen punten dubbelgeteld.

```{r}
mas_soortgrp %>%
  st_drop_geometry() %>%
  group_by(plotnaam, jaar, periode_in_jaar) %>%
  summarize(
    aantal_teldagen = n_distinct(doy),
    aantal_waarnemers = n_distinct(waarnemer),
    .groups = "drop"
  ) %>%
  filter(aantal_teldagen > 1 | aantal_waarnemers > 1) %>%
  kable()
```

## Soortnamen

We controleren de soortnamen. Voor de vogels hebben we:

```{r}
vogels <- mas_soortgrp %>%
  filter(soortgrp == 2) %>%
  distinct(naam) %>%
  arrange(naam) %>%
  pull(naam)
vogels
```

We vervangen `Engelse Kwikstaart` door `Gele Kwikstaart` en `Rouwkwikstaart` door `Witte Kwikstaart`.
We vervangen enkel de soortnaam. Het soortnummer blijft behouden.

Voor de zoogdieren hebben we:

```{r}
zoogdieren <- mas_soortgrp %>%
  filter(soortgrp == 1) %>%
  distinct(naam) %>%
  arrange(naam) %>%
  pull(naam)
zoogdieren
```

```{r}
# Code allows to adjust for other subspecies as well!
mas_2023_clean <- mas_soortgrp %>%
  mutate(
    naam = case_when(
      tolower(naam) %in% tolower(c(
        "gele kwikstaart (spec)",
        "engelse kwikstaart"
      ))
      ~ "Gele Kwikstaart",
      tolower(naam) %in% tolower(c(
        "witte kwikstaart (spec)",
        "Rouwkwikstaart"
      ))
      ~ "Witte Kwikstaart",
      tolower(naam) == tolower("canadese gans spec.")
      ~ "Grote Canadese Gans",
      tolower(naam) == tolower("Witsterblauwborst")
      ~ "Blauwborst",
      TRUE ~ naam
    )
  )
```

```{r}
glimpse(mas_2023_clean)
```

# Vogels 2023

```{r}
# Select birds
mas_2023_vogels <- mas_2023_clean %>%
  filter(soortgrp == 2) # birds
```

## Enkele cijfers

We bekijken eerst enkele cijfers per stratum.

```{r}
# Calculate number of plots, observations and species per stratum
summary_vogels_2023 <- mas_2023_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, jaar) %>%
  mutate(aantal_soorten_regiojaar = n_distinct(naam)) %>%
  group_by(regio, jaar, openheid_klasse, sbp) %>%
  mutate(
    aantal_waarnemingen = n_distinct(oid),
    aantal_telpunten = n_distinct(plotid),
    aantal_soorten_stratum = n_distinct(naam)
  ) %>%
  ungroup() %>%
  distinct(
    regio, jaar, openheid_klasse, sbp, aantal_waarnemingen, aantal_telpunten,
    aantal_soorten_stratum, aantal_soorten_regiojaar
  ) %>%
  arrange(regio, jaar, openheid_klasse, sbp)

write_csv(summary_vogels_2023, here(media_folder, "summary_vogels_2023.csv"))

summary_vogels_2023 %>%
  kable()
```

De meeste telpunten werden in alle telperiodes aangedaan.

```{r}
# Number of plots counted in each period
p <- mas_2023_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  summarise(
    aantal_telpunten = n_distinct(plotnaam),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = periode_in_jaar, y = aantal_telpunten)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = aantal_telpunten),
    position = position_dodge(width = 0.9), vjust = -0.25
  ) +
  facet_wrap(~regio) +
  labs(x = "Telperiode", y = "Totaal aantal telpunten")

save_figure(p, here(media_folder, "tellingen_vogels_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

Enkel in de Oostelijke leemstreek is er een telpunt waarvan we data van 1 periode hebben en 2 waarvan we data van 3 periodes hebben.

```{r}
# Count number of counting periods
mas_2023_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam) %>%
  summarise(
    aantal_periodes = n_distinct(periode_in_jaar),
    .groups = "drop"
  ) %>%
  count(regio, jaar, aantal_periodes, name = "aantal_telpunten") %>%
  kable()
```

VL0194 werd in principe 3x geteld maar deze had verschillende waarnemingen verder dan 300 meter.
Dit telpunt wordt weggelaten voor verdere analyses.
Ol_2214.11 werd niet in telperiode 4 geteld.
VL0209 werd niet in telperiode 4 geteld.

```{r}
mas_2023_vogels <- mas_2023_vogels %>%
  filter(plotnaam != "VL0194")
```

We kijken naar het aantal soorten.

```{r}
p <- mas_2023_vogels %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n_distinct(naam), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, fill = regio)) +
  geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_boxplot() +
  labs(x = "Telperiode", y = "Aantal soorten per telpunt", fill = "Regio")

save_figure(p, here(media_folder, "soorten_vogels_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

We kijken ook naar het aantal waarnemingen.

```{r}
# Number of observations counted in each period
p <- mas_2023_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  summarise(
    aantal_waarnemingen = n_distinct(oid),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = periode_in_jaar, y = aantal_waarnemingen)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = aantal_waarnemingen),
    position = position_dodge(width = 0.9), vjust = -0.25
  ) +
  facet_wrap(~regio) +
  labs(x = "Telperiode", y = "Totaal aantal waarnemingen")

save_figure(p, here(media_folder, "waarnemingen_tot_vogels_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```


```{r}
# Number of observations counted in each period
p <- mas_2023_vogels %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, fill = regio)) +
  geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_boxplot() +
  labs(x = "Telperiode", y = "Aantal waarnemingen per telpunt", fill = "Regio")

save_figure(p, here(media_folder, "waarnemingen_vogels_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

Voor verdere analyses groeperen we de Westelijke en Oostelijke leemstreek tot de Leemstreek.
We lezen de gewichten van de strata in zodat we eventueel kunnen rekening houden met onderlingen proporties per stratum.

```{r}
# Read in stratum weights sampling frame
gewichten_oostelijke_leemstreek <- read_csv(
  here("data", "steekproefkaders", "gewichten_oostelijke_leemstreek.csv")
)
gewichten_westelijke_leemstreek <- read_csv(
  here("data", "steekproefkaders", "gewichten_westelijke_leemstreek.csv")
)
gewichten_zandleemstreek <- read_csv(
  here("data", "steekproefkaders", "gewichten_zandleemstreek.csv")
)
```

We groeperen de gewichten per landbouwstreek (berekening proporties per landbouwstreek).
De som per landbouwstreek is dus 1.

```{r}
# Group weigths for Leemstreek
gewichten_mas_2023 <- bind_rows(
  gewichten_oostelijke_leemstreek,
  gewichten_westelijke_leemstreek,
  gewichten_zandleemstreek
) %>%
  mutate(landbouwstreek = ifelse(grepl("\\sleemstreek$", regio),
    "Leemstreek",
    regio
  )) %>%
  group_by(landbouwstreek) %>%
  mutate(
    totaal = sum(n),
    w = n / totaal
  ) %>%
  ungroup() %>%
  select(landbouwstreek, regio, openheid_klasse, sbp, n, w)

# Recalculate weights per agricultural region
gewicht_per_landbouwstreek <- gewichten_mas_2023 %>%
  group_by(landbouwstreek) %>%
  summarise(
    n = sum(n),
    .groups = "drop"
  ) %>%
  mutate(w = n / sum(n))

gewichten_mas_2023 %>%
  kable(digits = 3)
```

```{r}
# Add weigths to dataset
mas_2023_vogels <- full_join(mas_2023_vogels, gewichten_mas_2023,
  by = join_by(regio, openheid_klasse, sbp)
)
```

## Soortendiversiteit

Het aantal soorten neemt vooral toe in de eerste twee telperiodes.

```{r}
# Calculate the cumulative number of species over time for each agricultural
# region
cum_aantal_spec_strat <- mas_2023_vogels %>%
  st_drop_geometry() %>%
  group_by(landbouwstreek, naam) %>%
  filter(datum == min(datum)) %>%
  slice(1) %>% # takes the first occurrence if there is a tie
  ungroup() %>%
  group_by(landbouwstreek, datum) %>%
  summarise(
    n_spec = n_distinct(naam),
    .groups = "drop"
  ) %>%
  group_by(landbouwstreek) %>%
  arrange(datum) %>%
  mutate(cum_sum = cumsum(n_spec)) %>%
  ungroup()

# Create plot per region
jaar <- 2023 # year is 2023
cum_p1 <- cum_aantal_spec_strat %>%
  ggplot(aes(x = datum, y = cum_sum, colour = landbouwstreek)) +
  # Add shade for counting periods
  annotate("rect",
    xmin = ymd(paste(jaar, r1_start, sep = "-")),
    xmax = ymd(paste(jaar, r1_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R1",
    x = ymd(paste(jaar, r1_start, sep = "-")) +
      (ymd(paste(jaar, r1_stop, sep = "-")) -
        ymd(paste(jaar, r1_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r2_start, sep = "-")),
    xmax = ymd(paste(jaar, r2_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R2",
    x = ymd(paste(jaar, r2_start, sep = "-")) +
      (ymd(paste(jaar, r2_stop, sep = "-")) -
        ymd(paste(jaar, r2_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r3_start, sep = "-")),
    xmax = ymd(paste(jaar, r3_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R3",
    x = ymd(paste(jaar, r3_start, sep = "-")) +
      (ymd(paste(jaar, r3_stop, sep = "-")) -
        ymd(paste(jaar, r3_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r4_start, sep = "-")),
    xmax = ymd(paste(jaar, r4_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R4",
    x = ymd(paste(jaar, r4_start, sep = "-")) +
      (ymd(paste(jaar, r4_stop, sep = "-")) -
        ymd(paste(jaar, r4_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  # Add line
  geom_line(linewidth = 1) +
  labs(x = "", y = "Totaal aantal soorten", colour = "Regio") +
  theme(legend.position = "bottom")
```

We bekijken dit ook per stratum.

```{r}
# Calculate the cumulative number of species over time for each stratum
cum_aantal_spec_strat <- mas_2023_vogels %>%
  st_drop_geometry() %>%
  group_by(landbouwstreek, openheid_klasse, sbp, naam) %>%
  filter(datum == min(datum)) %>%
  slice(1) %>% # takes the first occurrence if there is a tie
  ungroup() %>%
  group_by(landbouwstreek, openheid_klasse, sbp, datum) %>%
  summarise(
    n_spec = n_distinct(naam),
    .groups = "drop"
  ) %>%
  group_by(landbouwstreek, openheid_klasse, sbp) %>%
  arrange(datum) %>%
  mutate(cum_sum = cumsum(n_spec)) %>%
  ungroup()

# Create plot per stratum
cum_p2 <- cum_aantal_spec_strat %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  ggplot(aes(x = datum, y = cum_sum, colour = stratum)) +
  # Add shade for counting periods
  annotate("rect",
    xmin = ymd(paste(jaar, r1_start, sep = "-")),
    xmax = ymd(paste(jaar, r1_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R1",
    x = ymd(paste(jaar, r1_start, sep = "-")) +
      (ymd(paste(jaar, r1_stop, sep = "-")) -
        ymd(paste(jaar, r1_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r2_start, sep = "-")),
    xmax = ymd(paste(jaar, r2_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R2",
    x = ymd(paste(jaar, r2_start, sep = "-")) +
      (ymd(paste(jaar, r2_stop, sep = "-")) -
        ymd(paste(jaar, r2_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r3_start, sep = "-")),
    xmax = ymd(paste(jaar, r3_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R3",
    x = ymd(paste(jaar, r3_start, sep = "-")) +
      (ymd(paste(jaar, r3_stop, sep = "-")) -
        ymd(paste(jaar, r3_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r4_start, sep = "-")),
    xmax = ymd(paste(jaar, r4_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R4",
    x = ymd(paste(jaar, r4_start, sep = "-")) +
      (ymd(paste(jaar, r4_stop, sep = "-")) -
        ymd(paste(jaar, r4_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  # Add line
  geom_line(linewidth = 1) +
  facet_wrap(~landbouwstreek) +
  labs(x = "", y = "Totaal aantal soorten", colour = "Regio") +
  theme(legend.position = "bottom")
```

```{r}
# Combine cumulative species plots
p <- gridExtra::grid.arrange(cum_p1, cum_p2)

save_figure(p, here(media_folder, "cum_soorten_vogels_2023"), devices,
  dpi = 300, width = 8, height = 8
)
```

Een overzicht van het aantal soorten per telpunt in de Westelijke leemstreek en de Zandleemstreek.

```{r}
# Calculate the number of species per stratum per period per region
p <- mas_2023_vogels %>%
  st_drop_geometry() %>%
  group_by(
    landbouwstreek, jaar, plotnaam, openheid_klasse, sbp, periode_in_jaar,
    naam
  ) %>%
  summarise(
    totaal_aantal = sum(aantal),
    .groups = "drop_last"
  ) %>%
  summarise(
    aantal_soorten = n(),
    .groups = "drop"
  ) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " -\n")) %>%
  ggplot() +
  geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_boxplot(aes(
    x = stratum, y = aantal_soorten,
    colour = periode_in_jaar
  )) +
  facet_wrap(~landbouwstreek) +
  labs(y = "Aantal soorten per telpunt", x = "", colour = "Telperiode")


save_figure(p, here(media_folder, "aantal_soorten_vogels_strat_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

Om welke soorten gaat het?

```{r}
# Define goal species
doelsoorten <- c(
  "Veldleeuwerik",
  "Gele Kwikstaart",
  "Geelgors",
  "Kievit",
  "Grasmus",
  "Witte Kwikstaart",
  "Ringmus",
  "Kwartel",
  "Kneu",
  "Torenvalk"
)
```

Voor elke soort kunnen we de relatieve frequentie ($P$) berekenen als de proportie telpunten waarin de soort aanwezig is per telperiode, stratum en regio.
Een relatieve frequentie van 0,5 wil dus zeggen dat de soort in 50 % van de telpunten gezien is.

$$
P = \sum_{i=1}^{N} I(n_i > 0) / N
$$

Waarbij $N$ het totaal aantal telpunten is in een bepaalde telperiode, stratum en regio en $n_i$ het aantal individuen van de beschouwde soort waargenomen aan telpunt $i$.
$I(\cdot)$ is de indicatorfunctie die 1 geeft als $n_i > 0$ en 0 anderzijds.
We selecteerden enkel waarnemingen met broedcode groter dan nul.
Voor roofvogels hielden we geen rekening met broedcode, omdat we voor deze soorten meer algemeen geïnteresseerd zijn in predatiedruk op de akkervogels.

```{r}
# Get design to add absences
bezoekenlijst_2023 <- mas_2023_vogels %>%
  st_drop_geometry() %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  distinct(landbouwstreek, regio, jaar, stratum, plotnaam, periode_in_jaar)

# Calculate relative frequencies
# We want a number for each bird species for each region, stratum, period
relfreqs_vogels <- mas_2023_vogels %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  st_drop_geometry() %>%
  # Only keep breeding birds except for predators
  filter(ifelse(naam %in% roofvogels_f(), wrntype >= 0L, wrntype > 0L)) %>%
  # Number of individuals per species per plot
  group_by(landbouwstreek, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(
    totaal_aantal = sum(aantal),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = naam,
    values_from = totaal_aantal,
    values_fill = list(totaal_aantal = 0)
  ) %>%
  # Add absences
  full_join(bezoekenlijst_2023,
    by = join_by(
      landbouwstreek, plotnaam, jaar, stratum,
      periode_in_jaar
    )
  ) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  # Calculate relative frequency for all species and pivot back to long format
  group_by(jaar, periode_in_jaar, landbouwstreek, stratum) %>%
  summarise(
    across(
      .cols = where(~ is.numeric(.x) && min(.x) == 0),
      .fns = ~ sum(.x > 0) / n()
    ),
    n = n(),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = where(is.double),
    names_to = "naam",
    values_to = "relfreq"
  ) %>%
  separate_wider_delim(stratum, " - ",
    names = c("openheid_klasse", "sbp")
  ) %>%
  # Add stratum weights
  full_join(select(gewichten_mas_2023, -n),
    relationship = "many-to-many",
    by = join_by(landbouwstreek, openheid_klasse, sbp)
  ) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  distinct()
```

Overzicht van relatieve frequenties van de 20 meest frequente soorten (of doelsoorten) in een bepaalde regio (gewogen gemiddelde per stratum).
Elk punt staat voor een relatieve frequentie in een bepaalde telperiode.
We nemen een gewogen gemiddelde per landbouwstreek waarbij de gewichten afhankelijk zijn van regio (in het geval van de Leemstreek, westelijk vs. oostelijk) en stratum.
Over de telperiodes heen mogen we wel een ongewogen gemiddelde nemen want dit zijn replicaten.

```{r}
library(ggtext)
highlight <- function(x, pat, color = "black", family = "") {
  ifelse(x %in% pat,
    glue::glue("<b style='font-family:{family}; color:{color}'>{x}</b>"),
    x
  )
}
```

```{r}
relfreq_vogels_regio <- relfreqs_vogels %>%
  # Calculate frequency per region, per period as a weighted average
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  # Calculate frequency per region as unweighted average
  group_by(landbouwstreek, jaar, naam) %>%
  summarise(gemiddelde_freq = mean(gemiddelde_freq)) %>%
  ungroup() %>%
  # Add weights of regions to calculate average over regions
  full_join(gewicht_per_landbouwstreek, by = join_by(landbouwstreek)) %>%
  group_by(jaar, naam) %>%
  mutate(order_var = weighted.mean(gemiddelde_freq, w)) %>%
  ungroup() %>%
  mutate(naam = reorder(naam, order_var,
    decreasing = FALSE
  )) %>%
  select(-c(n, w)) %>%
  pivot_wider(
    names_from = "landbouwstreek",
    values_from = "gemiddelde_freq"
  ) %>%
  select(naam, Leemstreek, Zandleemstreek, gewogen_gemiddelde = order_var) %>%
  arrange(desc(gewogen_gemiddelde)) %>%
  rownames_to_column(var = "rang") %>%
  mutate(rang = as.numeric(rang))

write_csv(relfreq_vogels_regio, here(media_folder, "relfreq_vogels_regio.csv"))

# Get 20 most frequent species or goal species
relfreq_vogels_regio %>%
  filter(rang <= 20 | naam %in% doelsoorten) %>%
  kable(digits = 3)
```

In de volgende figuur is elk punt een relatieve frequentie per telperiode.

```{r}
# Calculate relative frequency per region per period as weighted mean
freq_to_plot <- relfreqs_vogels %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  full_join(gewicht_per_landbouwstreek) %>%
  group_by(jaar, naam) %>%
  mutate(order_var = weighted.mean(gemiddelde_freq, w)) %>%
  ungroup() %>%
  # Retrieve 20 most common species + goal species
  mutate(naam = reorder(naam, order_var,
    decreasing = FALSE
  )) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 20 |
    naam %in% doelsoorten)

p <- freq_to_plot %>%
  ggplot() +
  geom_vline(xintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_hline(
    yintercept = length(unique(freq_to_plot$naam)) - 20 + 0.5,
    alpha = 0.2, linetype = "dashed"
  ) +
  geom_point(aes(x = gemiddelde_freq, y = naam, colour = landbouwstreek),
    size = 1
  ) +
  labs(y = "", x = "Relatieve frequentie", colour = "Regio") +
  scale_y_discrete(labels = function(x) highlight(x, doelsoorten, "red")) +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 8),
    axis.text.y = element_markdown(),
    panel.spacing = unit(0.7, "lines")
  ) +
  guides(colour = guide_legend(override.aes = list(size = 2)))

save_figure(p, here(media_folder, "vogelfreqs_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in de Zandleemstreek dan in de Leemstreek:

```{r}
# Calculate relative frequency per region per period as weighted mean
# Calculate difference between regions
relfreqs_vogels %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq_w = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  group_by(landbouwstreek, jaar, naam) %>%
  summarise(gemiddelde_freq = mean(gemiddelde_freq_w)) %>%
  ungroup() %>%
  distinct(landbouwstreek, naam, gemiddelde_freq) %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Zandleemstreek` - `Leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

```{r}
# Write out full csv
relfreqs_vogels %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq_w = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  group_by(landbouwstreek, jaar, naam) %>%
  summarise(gemiddelde_freq = mean(gemiddelde_freq_w)) %>%
  ungroup() %>%
  distinct(landbouwstreek, naam, gemiddelde_freq) %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Zandleemstreek` - `Leemstreek`) %>%
  ungroup() %>%
  arrange(desc(verschilfreq)) %>%
  rownames_to_column(var = "rang") %>%
  mutate(rang = as.numeric(rang)) %>%
  select(rang, naam, Zandleemstreek, Leemstreek, verschilfreq) %>%
  write_csv(here(media_folder, "relfreq_vogels_diff.csv"))
```

```{r}
# Calculate relative frequency per region per period as weighted mean
# Calculate difference between regions
relfreq_diff_zn <- relfreqs_vogels %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Zandleemstreek` - `Leemstreek`) %>%
  # Retrieve 20 most common species + goal species
  mutate(naam = reorder(naam, verschilfreq,
    FUN = "mean",
    decreasing = FALSE
  )) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 20 |
    naam %in% doelsoorten)

relfreq_diff_zn %>%
  ggplot() +
  geom_vline(
    xintercept = 0,
    colour = "lightgrey"
  ) +
  geom_hline(
    yintercept = length(unique(relfreq_diff_zn$naam)) - 20 + 0.5,
    alpha = 0.2, linetype = "dashed"
  ) +
  geom_point(aes(x = verschilfreq, y = naam),
    size = 1
  ) +
  labs(
    y = "", x = "Verschil in relatieve frequentie",
    title = "Algemener in de Zandleemstreek"
  ) +
  scale_y_discrete(labels = function(x) highlight(x, doelsoorten, "red")) +
  coord_cartesian(xlim = c(
    0 - abs(max(relfreq_diff_zn$verschilfreq)),
    0 + abs(max(relfreq_diff_zn$verschilfreq))
  )) +
  scale_x_continuous(breaks = seq(-1, 1, 0.05)) +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 8),
    axis.text.y = element_markdown(),
    panel.spacing = unit(1.2, "lines")
  ) +
  guides(colour = guide_legend(override.aes = list(size = 3)))
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in de Leemstreek dan in de Zandleemstreek:

```{r}
# Calculate relative frequency per region per period as weighted mean
# Calculate difference between regions
relfreqs_vogels %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq_w = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  group_by(landbouwstreek, jaar, naam) %>%
  summarise(gemiddelde_freq = mean(gemiddelde_freq_w)) %>%
  ungroup() %>%
  distinct(landbouwstreek, naam, gemiddelde_freq) %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Leemstreek` - `Zandleemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

```{r}
# Calculate relative frequency per region per period as weighted mean
# Calculate difference between regions
relfreq_diff_lm <- relfreqs_vogels %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Leemstreek` - `Zandleemstreek`) %>%
  # Retrieve 20 most common species + goal species
  mutate(naam = reorder(naam, verschilfreq,
    FUN = "mean",
    decreasing = FALSE
  )) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 20 |
    naam %in% doelsoorten)

relfreq_diff_lm %>%
  ggplot() +
  geom_vline(
    xintercept = 0,
    colour = "lightgrey"
  ) +
  geom_hline(
    yintercept = length(unique(relfreq_diff_lm$naam)) - 20 + 0.5,
    alpha = 0.2, linetype = "dashed"
  ) +
  geom_point(aes(x = verschilfreq, y = naam),
    size = 1
  ) +
  labs(
    y = "", x = "Verschil in relatieve frequentie",
    title = "Algemener in de Leemstreek"
  ) +
  scale_y_discrete(labels = function(x) highlight(x, doelsoorten, "red")) +
  coord_cartesian(xlim = c(
    0 - abs(max(relfreq_diff_lm$verschilfreq)),
    0 + abs(max(relfreq_diff_lm$verschilfreq))
  )) +
  scale_x_continuous(breaks = seq(-1, 1, 0.05)) +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 8),
    axis.text.y = element_markdown(),
    panel.spacing = unit(1.2, "lines")
  ) +
  guides(colour = guide_legend(override.aes = list(size = 3)))
```

Top 10 van beide kanten in 1 figuur.

```{r}
# Calculate relative frequency per region per period as weighted mean
# Calculate difference between regions
relfreq_diff_total <- relfreqs_vogels %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Zandleemstreek` - `Leemstreek`) %>%
  # Retrieve 20 most common species IN BOTH DIRECTIONS + goal species
  mutate(naam = reorder(naam, verschilfreq,
    FUN = "mean",
    decreasing = FALSE
  )) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 10 |
    as.numeric(naam) <= 10 |
    naam %in% doelsoorten)

p <- relfreq_diff_total %>%
  ggplot() +
  geom_vline(
    xintercept = 0,
    colour = "lightgrey"
  ) +
  geom_hline(
    yintercept = c(
      10.5,
      length(unique(relfreq_diff_total$naam)) - 10 + 0.5
    ),
    alpha = 0.2, linetype = "dashed"
  ) +
  geom_point(aes(x = verschilfreq, y = naam),
    size = 1
  ) +
  labs(y = "", x = "Verschil in relatieve frequentie") +
  scale_y_discrete(labels = function(x) highlight(x, doelsoorten, "red")) +
  coord_cartesian(xlim = c(
    0 - abs(max(relfreq_diff_zn$verschilfreq)),
    0 + abs(max(relfreq_diff_zn$verschilfreq))
  )) +
  scale_x_continuous(breaks = seq(-1, 1, 0.05)) +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 8),
    axis.text.y = element_markdown(),
    panel.spacing = unit(1.2, "lines")
  ) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  # Add arrows to indicate direction commonness in regions
  annotate("segment",
    x = c(abs(max(relfreq_diff_zn$verschilfreq))),
    y = c(length(unique(relfreq_diff_total$naam)) - 10 + 1),
    xend = c(abs(max(relfreq_diff_zn$verschilfreq))),
    yend = c(length(unique(relfreq_diff_total$naam)) - 10 + 3),
    arrow = arrow(type = "closed", length = unit(0.015, "npc")),
    colour = "black"
  ) +
  annotate("segment",
    x = c(abs(max(relfreq_diff_zn$verschilfreq))),
    y = c(10.5 - 0.5),
    xend = c(abs(max(relfreq_diff_zn$verschilfreq))),
    yend = c(10.5 - 2.5),
    arrow = arrow(type = "closed", length = unit(0.015, "npc")),
    colour = "black"
  ) +
  annotate("text",
    label = c("Zandleemstreek"),
    x = c(abs(max(relfreq_diff_zn$verschilfreq)) + 0.01),
    y = c(length(unique(relfreq_diff_total$naam)) - 10 + 1),
    size = 2, hjust = "left", colour = "black", angle = 90
  ) +
  annotate("text",
    label = c("Leemstreek"),
    x = c(abs(max(relfreq_diff_zn$verschilfreq)) + 0.01),
    y = c(10.5 - 0.5),
    size = 2, hjust = "right", colour = "black", angle = 90
  )

save_figure(p, here(media_folder, "vogelfreqs_diff_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

## Doelsoorten

We bekijken de relatieve frequenties van de doelsoorten in meer detail (per stratum).

```{r}
relfreqs_doelsoorten <- relfreqs_vogels %>%
  filter(naam %in% doelsoorten) %>% # only goal species
  # Calculate frequency per region, per period as a weighted average
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  # Calculate frequency per region as unweighted average
  group_by(landbouwstreek, jaar, naam) %>%
  summarise(gemiddelde_freq = mean(gemiddelde_freq)) %>%
  ungroup() %>%
  # Add weights of regions to calculate average over regions
  full_join(gewicht_per_landbouwstreek, by = join_by(landbouwstreek)) %>%
  group_by(jaar, naam) %>%
  mutate(order_var = weighted.mean(gemiddelde_freq, w)) %>%
  ungroup() %>%
  mutate(naam = reorder(naam, order_var,
    decreasing = FALSE
  )) %>%
  select(-c(n, w)) %>%
  pivot_wider(
    names_from = "landbouwstreek",
    values_from = "gemiddelde_freq"
  ) %>%
  select(naam, Leemstreek, Zandleemstreek, gewogen_gemiddelde = order_var)

relfreqs_doelsoorten %>%
  arrange(desc(gewogen_gemiddelde)) %>%
  kable(digits = 3)
```

We ordenen volgens gewogen gemiddelde.

```{r}
p <- relfreqs_vogels %>%
  filter(naam %in% doelsoorten) %>%
  full_join(
    relfreqs_doelsoorten %>%
      pivot_longer(
        cols = c("Leemstreek", "Zandleemstreek"),
        names_to = "landbouwstreek",
        values_to = "gemiddelde_freq"
      ) %>%
      distinct(landbouwstreek, naam, gewogen_gemiddelde),
    by = join_by(landbouwstreek, naam)
  ) %>%
  mutate(naam = reorder(naam, gewogen_gemiddelde,
    decreasing = FALSE
  )) %>%
  ggplot() +
  geom_vline(xintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_point(aes(x = relfreq, y = naam, colour = stratum),
    size = 1, position = position_dodge(width = 0.4)
  ) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.25)) +
  labs(y = "", x = "Relatieve frequentie", colour = "Stratum") +
  facet_grid(~landbouwstreek) +
  theme(legend.position = "top") +
  guides(colour = guide_legend(override.aes = list(size = 2)))

save_figure(p, here(media_folder, "vogelfreqs_2023_doelsoorten"), devices,
  dpi = 300, width = 8, height = 7
)

p
```

# Zoogdieren 2023

```{r}
# Select mammals
mas_2023_zoogdieren <- mas_2023_clean %>%
  filter(soortgrp == 1) # mammals
```

## Enkele cijfers

```{r}
# Calculate number of observations and species per stratum
summary_zoogdieren_2023 <- mas_2023_zoogdieren %>%
  st_drop_geometry() %>%
  group_by(regio, jaar) %>%
  mutate(aantal_soorten_regiojaar = n_distinct(naam)) %>%
  group_by(regio, jaar, openheid_klasse, sbp) %>%
  mutate(
    aantal_waarnemingen = n_distinct(oid),
    aantal_soorten_stratum = n_distinct(naam)
  ) %>%
  ungroup() %>%
  distinct(
    regio, jaar, openheid_klasse, sbp, aantal_waarnemingen,
    aantal_soorten_stratum, aantal_soorten_regiojaar
  ) %>%
  arrange(regio, jaar, openheid_klasse, sbp)

write_csv(summary_zoogdieren_2023, here(media_folder, "summary_zoogdieren_2023.csv"))

summary_zoogdieren_2023 %>%
  kable()
```

We kijken naar het aantal waarnemingen.

```{r}
# Number of observations counted in each period
p <- mas_2023_zoogdieren %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  summarise(
    aantal_waarnemingen = n_distinct(oid),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = periode_in_jaar, y = aantal_waarnemingen)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = aantal_waarnemingen),
    position = position_dodge(width = 0.9), vjust = -0.25
  ) +
  facet_wrap(~regio) +
  labs(x = "Telperiode", y = "Totaal aantal waarnemingen")

save_figure(p, here(media_folder, "waarnemingen_tot_zoogdieren_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

Voor verdere analyses groeperen we de Westelijke en Oostelijke leemstreek tot de Leemstreek.

```{r}
# Add weigths to dataset
mas_2023_zoogdieren <- full_join(mas_2023_zoogdieren, gewichten_mas_2023,
  by = join_by(regio, openheid_klasse, sbp)
)
```


## Soortendiversiteit

Het aantal soorten neemt vooral toe in de eerste twee telperiodes.

```{r}
# Calculate the cumulative number of species over time for each agricultural
# region
cum_aantal_spec_strat <- mas_2023_zoogdieren %>%
  st_drop_geometry() %>%
  group_by(landbouwstreek, naam) %>%
  filter(datum == min(datum)) %>%
  slice(1) %>% # takes the first occurrence if there is a tie
  ungroup() %>%
  group_by(landbouwstreek, datum) %>%
  summarise(
    n_spec = n_distinct(naam),
    .groups = "drop"
  ) %>%
  group_by(landbouwstreek) %>%
  arrange(datum) %>%
  mutate(cum_sum = cumsum(n_spec)) %>%
  ungroup()

# Create plot per region
cum_p1 <- cum_aantal_spec_strat %>%
  ggplot(aes(x = datum, y = cum_sum, colour = landbouwstreek)) +
  annotate("rect",
    xmin = ymd(paste(jaar, r1_start, sep = "-")),
    xmax = ymd(paste(jaar, r1_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R1",
    x = ymd(paste(jaar, r1_start, sep = "-")) +
      (ymd(paste(jaar, r1_stop, sep = "-")) -
        ymd(paste(jaar, r1_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r2_start, sep = "-")),
    xmax = ymd(paste(jaar, r2_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R2",
    x = ymd(paste(jaar, r2_start, sep = "-")) +
      (ymd(paste(jaar, r2_stop, sep = "-")) -
        ymd(paste(jaar, r2_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r3_start, sep = "-")),
    xmax = ymd(paste(jaar, r3_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R3",
    x = ymd(paste(jaar, r3_start, sep = "-")) +
      (ymd(paste(jaar, r3_stop, sep = "-")) -
        ymd(paste(jaar, r3_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r4_start, sep = "-")),
    xmax = ymd(paste(jaar, r4_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R4",
    x = ymd(paste(jaar, r4_start, sep = "-")) +
      (ymd(paste(jaar, r4_stop, sep = "-")) -
        ymd(paste(jaar, r4_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  geom_line(linewidth = 1) +
  labs(x = "", y = "Totaal aantal soorten", colour = "Regio") +
  theme(legend.position = "bottom")
```

We bekijken dit ook per stratum.

```{r}
# Calculate the cumulative number of species over time for each stratum
cum_aantal_spec_strat <- mas_2023_zoogdieren %>%
  st_drop_geometry() %>%
  group_by(landbouwstreek, openheid_klasse, sbp, naam) %>%
  filter(datum == min(datum)) %>%
  slice(1) %>% # takes the first occurrence if there is a tie
  ungroup() %>%
  group_by(landbouwstreek, openheid_klasse, sbp, datum) %>%
  summarise(
    n_spec = n_distinct(naam),
    .groups = "drop"
  ) %>%
  group_by(landbouwstreek, openheid_klasse, sbp) %>%
  arrange(datum) %>%
  mutate(cum_sum = cumsum(n_spec)) %>%
  ungroup()

# Create plot per stratum
cum_p2 <- cum_aantal_spec_strat %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  ggplot(aes(x = datum, y = cum_sum, colour = stratum)) +
  annotate("rect",
    xmin = ymd(paste(jaar, r1_start, sep = "-")),
    xmax = ymd(paste(jaar, r1_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R1",
    x = ymd(paste(jaar, r1_start, sep = "-")) +
      (ymd(paste(jaar, r1_stop, sep = "-")) -
        ymd(paste(jaar, r1_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r2_start, sep = "-")),
    xmax = ymd(paste(jaar, r2_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R2",
    x = ymd(paste(jaar, r2_start, sep = "-")) +
      (ymd(paste(jaar, r2_stop, sep = "-")) -
        ymd(paste(jaar, r2_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r3_start, sep = "-")),
    xmax = ymd(paste(jaar, r3_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R3",
    x = ymd(paste(jaar, r3_start, sep = "-")) +
      (ymd(paste(jaar, r3_stop, sep = "-")) -
        ymd(paste(jaar, r3_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  annotate("rect",
    xmin = ymd(paste(jaar, r4_start, sep = "-")),
    xmax = ymd(paste(jaar, r4_stop, sep = "-")),
    ymin = 0, ymax = Inf,
    alpha = 0.2
  ) +
  annotate("text",
    label = "R4",
    x = ymd(paste(jaar, r4_start, sep = "-")) +
      (ymd(paste(jaar, r4_stop, sep = "-")) -
        ymd(paste(jaar, r4_start, sep = "-"))) / 2,
    y = 0,
    vjust = -1
  ) +
  geom_line(linewidth = 1) +
  facet_wrap(~landbouwstreek) +
  labs(x = "", y = "Totaal aantal soorten", colour = "Regio") +
  theme(legend.position = "bottom")
```

```{r}
# Combine cumulative species plots
p <- gridExtra::grid.arrange(cum_p1, cum_p2)

save_figure(p, here(media_folder, "cum_soorten_zoogdieren_2023"), devices,
  dpi = 300, width = 8, height = 8
)
```

Voor elke soort kunnen we de relatieve frequentie ($P$) berekenen als de proportie telpunten waarin de soort aanwezig is per telperiode, stratum en regio.

```{r}
# Calculate relative frequencies
# We want a number for each species for each region, stratum, period
relfreqs_zoogdieren <- mas_2023_zoogdieren %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  st_drop_geometry() %>%
  # Number of individuals per species per plot
  group_by(landbouwstreek, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(
    totaal_aantal = sum(aantal),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = naam,
    values_from = totaal_aantal,
    values_fill = list(totaal_aantal = 0)
  ) %>%
  # Add absences
  full_join(bezoekenlijst_2023,
    by = join_by(
      landbouwstreek, plotnaam, jaar, stratum,
      periode_in_jaar
    )
  ) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  # Calculate relative frequency for all species and pivot back to long format
  group_by(jaar, periode_in_jaar, landbouwstreek, stratum) %>%
  summarise(
    across(
      .cols = where(~ is.numeric(.x) && min(.x) == 0),
      .fns = ~ sum(.x > 0) / n()
    ),
    n = n(),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = where(is.double),
    names_to = "naam",
    values_to = "relfreq"
  ) %>%
  separate_wider_delim(stratum, " - ",
    names = c("openheid_klasse", "sbp")
  ) %>%
  # Add stratum weights
  full_join(select(gewichten_mas_2023, -n),
    relationship = "many-to-many",
    by = join_by(landbouwstreek, openheid_klasse, sbp)
  ) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - ")) %>%
  distinct()
```

Overzicht van relatieve frequenties van de 20 meest frequente soorten in een bepaalde regio (gewogen gemiddelde).
Elk punt staat voor een relatieve frequentie in een bepaalde telperiode.
We nemen een gewogen gemiddelde per landbouwstreek waarbij de gewichten afhankelijk zijn van regio (in het geval van de Leemstreek, westelijk vs. oostelijk) en stratum.
Over de telperiodes heen mogen we wel een ongewogen gemiddelde nemen want dit zijn replicaten.

```{r}
relfreq_zoogdieren_regio <- relfreqs_zoogdieren %>%
  # Calculate frequency per region, per period as a weighted average
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  # Calculate frequency per region as unweighted average
  group_by(landbouwstreek, jaar, naam) %>%
  summarise(gemiddelde_freq = mean(gemiddelde_freq)) %>%
  ungroup() %>%
  # Add weights of regions to calculate average over regions
  full_join(gewicht_per_landbouwstreek) %>%
  group_by(jaar, naam) %>%
  mutate(order_var = weighted.mean(gemiddelde_freq, w)) %>%
  ungroup() %>%
  mutate(naam = reorder(naam, order_var,
    decreasing = FALSE
  )) %>%
  select(-c(n, w)) %>%
  pivot_wider(
    names_from = "landbouwstreek",
    values_from = "gemiddelde_freq"
  ) %>%
  select(naam, Leemstreek, Zandleemstreek, gewogen_gemiddelde = order_var) %>%
  arrange(desc(gewogen_gemiddelde)) %>%
  rownames_to_column(var = "rang") %>%
  mutate(rang = as.numeric(rang))

write_csv(
  relfreq_zoogdieren_regio,
  here(media_folder, "relfreq_zoogdieren_regio.csv")
)

relfreq_zoogdieren_regio %>%
  kable(digits = 5)
```

In de volgende figuur is elk punt een relatieve frequentie per telperiode.

```{r}
# Calculate relative frequency per region per period as weighted mean
freq_to_plot <- relfreqs_zoogdieren %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  full_join(gewicht_per_landbouwstreek) %>%
  group_by(jaar, naam) %>%
  mutate(order_var = weighted.mean(gemiddelde_freq, w)) %>%
  ungroup() %>%
  mutate(naam = reorder(naam, order_var,
    decreasing = FALSE
  ))

p <- freq_to_plot %>%
  ggplot() +
  geom_vline(xintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_point(aes(x = gemiddelde_freq, y = naam, colour = landbouwstreek),
    size = 1
  ) +
  labs(y = "", x = "Relatieve frequentie", colour = "Regio") +
  scale_y_discrete(labels = function(x) highlight(x, doelsoorten, "red")) +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 8),
    axis.text.y = element_markdown(),
    panel.spacing = unit(0.7, "lines")
  ) +
  guides(colour = guide_legend(override.aes = list(size = 2)))

save_figure(p, here(media_folder, "zoogdierfreqs_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in de Zandleemstreek dan in de Leemstreek:

```{r}
# Calculate relative frequency per region per period as weighted mean
# Calculate difference between regions
relfreqs_zoogdieren_diff <- relfreqs_zoogdieren %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq_w = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  group_by(landbouwstreek, jaar, naam) %>%
  summarise(gemiddelde_freq = mean(gemiddelde_freq_w)) %>%
  ungroup() %>%
  distinct(landbouwstreek, naam, gemiddelde_freq) %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Zandleemstreek` - `Leemstreek`) %>%
  ungroup() %>%
  arrange(desc(verschilfreq)) %>%
  rownames_to_column(var = "rang") %>%
  mutate(rang = as.numeric(rang)) %>%
  select(rang, naam, Zandleemstreek, Leemstreek, verschilfreq)


write_csv(
  relfreqs_zoogdieren_diff,
  here(media_folder, "relfreq_zoogdieren_diff.csv")
)

relfreqs_zoogdieren_diff %>%
  kable(digits = 2)
```

```{r}
# Calculate relative frequency per region per period as weighted mean
# Calculate difference between regions
relfreq_diff_zn <- relfreqs_zoogdieren %>%
  group_by(landbouwstreek, jaar, periode_in_jaar, naam) %>%
  summarise(gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  ungroup() %>%
  pivot_wider(
    names_from = landbouwstreek,
    values_from = gemiddelde_freq,
    values_fill = 0
  ) %>%
  mutate(verschilfreq = `Zandleemstreek` - `Leemstreek`) %>%
  mutate(naam = reorder(naam, verschilfreq,
    FUN = "mean",
    decreasing = FALSE
  ))

p <- relfreq_diff_zn %>%
  ggplot() +
  geom_vline(
    xintercept = 0,
    colour = "lightgrey"
  ) +
  geom_point(aes(x = verschilfreq, y = naam),
    size = 1
  ) +
  labs(y = "", x = "Verschil in relatieve frequentie") +
  scale_y_discrete(labels = function(x) highlight(x, doelsoorten, "red")) +
  coord_cartesian(xlim = c(
    0 - abs(max(relfreq_diff_zn$verschilfreq)),
    0 + abs(max(relfreq_diff_zn$verschilfreq))
  )) +
  scale_x_continuous(breaks = seq(-1, 1, 0.05)) +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 8),
    axis.text.y = element_markdown(),
    panel.spacing = unit(1.2, "lines")
  ) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  # Add arrows to indicate direction commonness in regions
  annotate("segment",
    x = 0.01,
    y = 0.75,
    xend = 0.05,
    yend = 0.75,
    arrow = arrow(type = "closed", length = unit(0.015, "npc")),
    colour = "black"
  ) +
  annotate("segment",
    x = -0.01,
    y = 0.75,
    xend = -0.05,
    yend = 0.75,
    arrow = arrow(type = "closed", length = unit(0.015, "npc")),
    colour = "black"
  ) +
  annotate("text",
    label = c("Zandleemstreek"),
    x = 0.01,
    y = 0.6,
    size = 2, hjust = "left", colour = "black"
  ) +
  annotate("text",
    label = c("Leemstreek"),
    x = -0.01,
    y = 0.6,
    size = 2, hjust = "right", colour = "black"
  )

save_figure(p, here(media_folder, "zoogdierfreqs_diff_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

## Haas

We bekijken Haas in meer detail.
Er worden in beide regio's meest individuen gespot in periode 3, dan 1, dan 4 en dan 2.

```{r}
# Count number of individuals per region and period for Hare
p <- mas_2023_zoogdieren %>%
  st_drop_geometry() %>%
  filter(naam == "Haas") %>%
  group_by(landbouwstreek, jaar, periode_in_jaar) %>%
  summarise(
    totaal_aantal = sum(aantal),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = periode_in_jaar, y = totaal_aantal)) +
  geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_bar(stat = "identity") +
  geom_text(aes(label = totaal_aantal),
    position = position_dodge(width = 0.9), vjust = -0.25
  ) +
  facet_wrap(~landbouwstreek) +
  labs(y = "Totaal aantal individuen", x = "Telperiode", fill = "Jaar")

save_figure(p, here(media_folder, "aantal_hazen_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```

De relatieve frequenties liggen hoger in open landschap voor beide streken.

```{r}
# Visualise rel. freq. per region, stratum and period for Hare
p <- relfreqs_zoogdieren %>%
  filter(naam == "Haas") %>%
  ggplot() +
  geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_point(aes(y = relfreq, x = stratum, shape = periode_in_jaar),
    size = 3, position = position_dodge(width = 0.3)
  ) +
  scale_y_continuous(limits = c(0, NA)) +
  labs(y = "Relatieve frequentie", x = "", shape = "Telperiode") +
  facet_grid(~landbouwstreek) +
  theme(legend.position = "top")

save_figure(p, here(media_folder, "relfreq_haas_2023"), devices,
  dpi = 300, width = 8, height = 6
)

p
```
