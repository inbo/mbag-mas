---
title: "Exploratie uitbreiding MAS 2023"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())

Sys.setenv("PROJ_NETWORK" = "ON")
```

```{r}
# packages
library(tidyverse)
library(INBOtheme)
library(sf)

theme_set(theme_inbo(transparent = TRUE))

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::lag)

# Paths
data_path <- here("data", "mas")
media_path <- here("media", "exploratie_2023")
dir.create(media_path, showWarnings = FALSE)
```

# Doel

Exploratie gegevens Zandleemstreek en Westelijke leemstreek 2023 voor eerste rapport MBAG.


# Inlezen data

```{r}
file_geojson_2023 <- file.path(data_path, 
                               "20230810_qgis_export_sovon_wfs_2023.geojson")
mas_geojson_2023 <- read_sf(file_geojson_2023)
```

We moeten een reeks selecties en data preparatiestappen doen.
In een later stadium worden deze best in een analysepijplijn (bv. targets) gegoten.

## CRS

De CRS moet aangepast worden naar van Amersfoort naar Lambert 72. Dit doen we via een specifieke pipeline, zie: https://inbo.github.io/tutorials/tutorials/spatial_transform_crs_2/

```{r}
pipelines <- sf_proj_pipelines("EPSG:28992", "EPSG:31370")
glimpse(pipelines)
```

```{r}
# We select the pipeline with lowest accuracy (< 0.02), by filtering on accuracy.
# If the grids are installed, this should match the first line of the pipelines object.
chosen_pipeline_definition <- pipelines %>%
  filter(accuracy < 0.02) %>% 
  pull(definition)

mas_31370_pipeline <- 
  st_transform(st_geometry(mas_geojson_2023), "EPSG:31370",
               pipeline = chosen_pipeline_definition) %>% 
  st_sf(st_drop_geometry(mas_geojson_2023), geometry = .) %>% 
  as_tibble() %>% 
  st_as_sf() %>%
  rename(x_amersfoord = x_coord,
         y_amersfoord = y_coord) %>%
  mutate(x_lambert = unlist(map(.data$geometry, 1)),
         y_lambert = unlist(map(.data$geometry, 2))) %>%
  select(oid:y_amersfoord, x_lambert, y_lambert, everything())
```

## Data selectie
### Landbouwstreken

We selecteren de data van de Zandleemstreek en de Westelijke leemstreek.
Dit doen we door te joinen met de steekproef.

```{r}
steekproef_avimap <- read_csv(here("data", "steekproefkaders",
                                   "steekproef_avimap_mbag_piloot.csv"))

steekproef_avimap_subset <- steekproef_avimap %>%
  filter(regio %in% c("Westelijke leemstreek", "Zandleemstreek"))

mas_data_regios <- mas_31370_pipeline %>%
  inner_join(steekproef_avimap_subset, by = join_by(plotnaam == pointid))
```

### Telrondes

We selecteren dan de MAS-data binnen de telrondes.

```{r}
r1_start <- "04-01"
r1_stop  <- "04-20"
r2_start <- "04-21"
r2_stop  <- "05-10"
r3_start <- "05-11"
r3_stop  <- "06-10"
r4_start <- "06-21"
r4_stop  <- "07-15"

mas_telperiodes <- mas_data_regios %>%
  mutate(
    datum = ymd(paste(jaar, maand, dag, sep = "-")),
    periode_in_jaar = case_when(
      datum %within% interval(
        ymd(paste(jaar, r1_start, sep = "-")),
        ymd(paste(jaar, r1_stop, sep = "-"))) ~ "R1",
      datum %within% interval(
        ymd(paste(jaar, r2_start, sep = "-")),
        ymd(paste(jaar, r2_stop, sep = "-"))) ~ "R2",
      datum %within% interval(
        ymd(paste(jaar, r3_start, sep = "-")),
        ymd(paste(jaar, r3_stop, sep = "-"))) ~ "R3",
      datum %within% interval(
        ymd(paste(jaar, r4_start, sep = "-")),
        ymd(paste(jaar, r4_stop, sep = "-"))) ~ "R4"
    )) %>%
  filter(!is.na(periode_in_jaar))
```

### Telcirkel

We herberekenen de afstanden tussen de waarnemingen en de telpunten. We ronden af to 1 m nauwkeurig.

```{r}
steekproef_avimap_subset_sf <- steekproef_avimap_subset %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 31370) %>%
  select(plotnaam = pointid, regio, geometry)

mas_controle_afstand <- mas_telperiodes %>%
  select(oid, plotnaam, distance2plot, naam, jaar, waarnemer = waarneme) %>%
  inner_join(steekproef_avimap_subset_sf %>% as_tibble(),
             by = c("plotnaam"), suffix = c(".stip", ".telpunt")) %>%
  mutate(calc_distance = st_distance(.$geometry.stip, .$geometry.telpunt,
            by_element = TRUE),
         calc_distance = round(units::drop_units(calc_distance))) %>%
  st_drop_geometry()
```

We selecteren vervolgens alle waarnemingen binnen een afstand van 300 m.

```{r}
mas_distance <- mas_telperiodes %>%
  full_join(mas_controle_afstand, 
            by = join_by(oid, plotnaam, naam, jaar, distance2plot, regio)) %>%
  select(-c(distance2plot, geometry.telpunt, waarneme)) %>%
  rename(distance2plot = calc_distance) %>%
  filter(distance2plot <= 300)
```

De afstanden van de waarnemingen tot het middelpunt zijn correct:

```{r}
detail <- c("xmin" = 194000,
            "ymin" = 179000,
            "xmax" = 201000,
            "ymax" = 185000)

detail_sf <- tibble(geometry = st_as_sfc(st_bbox(detail))) %>% 
  st_as_sf() %>%
  st_set_crs(31370)

mapview::mapview(st_crop(steekproef_avimap_subset_sf, detail_sf),
                 legend = FALSE) +
  mapview::mapview(st_crop(st_buffer(mas_distance, mas_distance$distance2plot),
                           detail_sf), 
                   alpha.regions = 0,
                   legend = FALSE) +
  mapview::mapview(detail_sf, alpha.regions = 0)
```

