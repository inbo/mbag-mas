---
title: "Darwin Core mapping MAS data"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# Packages
library(tidyverse)
library(targets)
library(sf)
library(here)

# Path to target store
targets_store <- here("source", "targets", "data_preparation", "_targets")
```

# Doel en werkwijze

We willen de MAS data publiceren op GBIF.
Hiervoor moeten we de dataset "publicatieklaar" maken.

Deze workflow kan worden toegevoegd aan de targets pipeline.
Voorlopig werken we met dit document tot we de finale workflow voor publicatie af hebben.

# Darwin Core mapping

We standardiseren de kolommen o.b.v. [Darwin Core termen](https://dwc.tdwg.org/terms/).

## Data preparatie

We lezen de input data in.

```{r}
raw_data <- tar_read(mas_data_clean, store = targets_store)

# How does the data look like?
glimpse(raw_data)
```

We passen de kolomnamen aan en nemen een kopie van de data.

```{r}
# Add prefix `raw_` to the column names of `raw_data`
colnames(raw_data) <- paste0("raw_", colnames(raw_data))

# Generate taxon core by making a copy of raw_data
taxon_core <- raw_data 
```

## Ruimtelijke verwerking

- We verwijderen de Amersfoord coördinaten
- We zetten de Lambert coördinaten om naar WGS 84 decimale coördinaten
- We behouden de Lambert coördinaten als verbatim coördinaten

```{r}
taxon_core <- taxon_core %>%
  # Remove Amersfoord coordinates
  select(-"x_amersfoord", -"y_amersfoord") %>%
  # Keep original X, Y as verbatim coordinates
  rename(
    "dwc_verbatimLatitude" = "y_lambert",
    "dwc_verbatimLongitude" = "x_lambert") %>%
  mutate(
    dwc_verbatimCoordinateSystem = "BD72 / Belgian Lambert 72",
    dwc_verbatimSRS = "EPSG:31370") %>%
  # Convert to WGS 84 decimal coordinates
  st_transform(4326) %>%
  mutate(
    dwc_decimalLatitude = round(st_coordinates(.data$geometry)[, 2], 5),
    dwc_decimalLongitude = round(st_coordinates(.data$geometry)[, 1], 5),
    dwc_geodeticDatum = "EPSG:4326") %>%
  st_drop_geometry()
```

## Statische waarden

Statische waarden hebben dezelfde waarde voor alle records.

## Onveranderde waarden

## Aangepaste waarden

```{r}


# Static values
## Static values have the same value for all records
taxon_core <- taxon_core %>%
  mutate(
    dwc_type = "Event",
    # dwc_datasetID = "insert doi",
    dwc_language = "nl",
    dwc_license = "http://creativecommons.org/publicdomain/zero/1.0/",
    dwc_rightsHolder = "INBO",
    dwc_accessRights = "http://www.inbo.be/en/norms-for-data-use",
    dwc_institutionCode = "INBO",
    #dwc_datasetName = "name",
    dwc_ownerInstitutionCode = "INBO",
    dwc_kingdom = "Animalia",
    dwc_nomenclaturalCode = "ICZN",
    dwc_taxonRank = "species",
    dwc_eventType = "Survey",
    dwc_samplingProtocol = "...",
    dwc_continent = "Europe",
    dwc_country = "Belgium",
    dwc_stateProvince = "Flanders",
    dwc_countryCode = "BE",
    dwc_basisOfRecord = "HumanObservation"
  )

# Unaltered values
# The content is an exact copy of the corresponding field of the raw data
taxon_core <- taxon_core %>%
  rename(
    "dwc_vernacularName" = "naam",
    "dwc_eventDate" = "datum",
    "dwc_year" = "jaar",
    "dwc_month" = "maand",
    "dwc_day" = "dag",
    "dwc_recordedBy" = "waarnemer",
    "dwc_individualCount" = "aantal",
    "dwc_locationID" = "plotnaam",
    "dwc_varbatimBehavior" = "wrntype_omschrijving")


# Altered values
taxon_core <- taxon_core %>%
  mutate(
    dwc_occurrenceID = paste0("MBAG:MAS:", oid),
    dwc_eventID = paste0("MBAG:MAS:", dwc_eventDate, dwc_locationID),
    dwc_class = ifelse(.data$soortgrp == 2, "Aves", "Mammalia"),
    dwc_behavior = case_when(
      .data$dwc_varbatimBehavior == "Territoriaal gedrag" ~
        "Teritorial behaviour",
      .data$dwc_varbatimBehavior == "Individu of groep niet plaatsgebonden" ~
        "Individual or group not bound to a location",
      .data$dwc_varbatimBehavior == "Volwassen individu in broedbiotoop" ~
        "Adult individual in breeding habitat",
      .data$dwc_varbatimBehavior == "Nestvondst" ~
        "Nest discovery",
      .data$dwc_varbatimBehavior == "Nest-aanduidend gedrag" ~
        "Nest-indicating behaviour",
      .data$dwc_varbatimBehavior == "Paar in broedbiotoop" ~
        "Pair in breeding habitat"
    )) %>%
  select(-"soortgrp",
         -"wrntype")

# Presence absence data
taxon_core <- taxon_core
# pivot add zeroes dwc_individualCount = ifelse(dwc_individualCount > 0, "Present", "Absent")
```

