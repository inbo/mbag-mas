---
title: "Darwin Core mapping MAS data"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: show
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# Packages
library(tidyverse)
library(targets)
library(sf)
library(here)

# Source functions
source(here("source", "R", "taxon_mapping.R"))

# Path to target store
targets_store <- here("source", "targets", "data_preparation", "_targets")
```

# Doel en werkwijze

We willen de MAS data publiceren op GBIF.
Hiervoor moeten we de dataset "publicatieklaar" maken.

Deze workflow kan worden toegevoegd aan de targets pipeline.
Voorlopig werken we met dit document tot we de finale workflow voor publicatie af hebben.

# Darwin Core mapping

We standaardiseren de kolommen o.b.v. [Darwin Core-termen](https://dwc.tdwg.org/terms/).

## Data preparatie

We lezen de input data in.

```{r}
raw_data <- tar_read(mas_data_clean, store = targets_store)

# How does the data look like?
glimpse(raw_data)
```

We verwijderen kolommen gerelateerd aan de steekproef.

```{r}
raw_data <- raw_data %>%
  select(
    -"batch",
    -"sample_order"
  )
```


We passen de kolomnamen aan en nemen een kopie van de data.

```{r}
# Add prefix `raw_` to the column names of `raw_data`
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
st_geometry(raw_data) <- "raw_geometry"

# Generate taxon core by making a copy of raw_data
taxon_core <- raw_data
```

## Ruimtelijke verwerking

- We verwijderen de Amersfoord coördinaten
- We zetten de Lambert coördinaten om naar WGS 84 decimale coördinaten
- We behouden de Lambert coördinaten als verbatim coördinaten

```{r}
taxon_core <- taxon_core %>%
  # Remove Amersfoord coordinates
  select(
    -"raw_x_amersfoord",
    -"raw_y_amersfoord"
  ) %>%
  # Keep original X, Y as verbatim coordinates
  rename(
    "dwc_verbatimLatitude" = "raw_y_lambert",
    "dwc_verbatimLongitude" = "raw_x_lambert"
  ) %>%
  mutate(
    dwc_verbatimCoordinateSystem = "BD72 / Belgian Lambert 72",
    dwc_verbatimSRS = "EPSG:31370"
  ) %>%
  # Convert to WGS 84 decimal coordinates
  st_transform(4326) %>%
  mutate(
    dwc_decimalLatitude = round(st_coordinates(.data$raw_geometry)[, 2], 5),
    dwc_decimalLongitude = round(st_coordinates(.data$raw_geometry)[, 1], 5),
    dwc_geodeticDatum = "EPSG:4326"
  ) %>%
  st_drop_geometry()
```

## Statische waarden

Statische waarden worden gebruikt voor Darwin Core-termen die dezelfde waarde nodig hebben voor alle records.
Meestal ontbreken ze in `raw_data`.

```{r}
taxon_core <- taxon_core %>%
  mutate(
    #dwc_type                = "Event",
    #dwc_datasetID           = "insert doi",
    dwc_language             = "en",
    dwc_license              = paste0("http://creativecommons.org/publicdomain",
                                      "/zero/1.0/"),
    dwc_publisher            = "Research Institute for Nature and Forest (INBO)",
    dwc_rightsHolder         = "INBO",
    dwc_accessRights         = "http://www.inbo.be/en/norms-for-data-use",
    dwc_institutionCode      = "INBO",
    #dwc_datasetName         = "name",
    dwc_ownerInstitutionCode = "INBO",
    dwc_collectionCode       = "MAS",
    dwc_kingdom              = "Animalia",
    dwc_nomenclaturalCode    = "ICZN",
    dwc_taxonRank            = "species",
    dwc_eventType            = "Survey",
    #dwc_samplingProtocol    = "...",
    #dwc_samplingEffort      = "...",
    dwc_continent            = "Europe",
    dwc_country              = "Belgium",
    dwc_stateProvince        = "Flanders",
    dwc_countryCode          = "BE",
    dwc_basisOfRecord        = "HumanObservation"
  )
```

**Vragen**

- Wat vul ik in voor volgende termen?
  - `dwc_type`
  - `dwc_datasetID`
  - `dwc_datasetName`
  - `dwc_samplingProtocol`
  - `dwc_samplingEffort`
- Is `dwc_language = "en"` ok?
- Is `dwc_eventType = "Survey"` ok?

## Ongewijzigde waarden

Ongewijzigde waarden worden gebruikt voor Darwin Core-termen waarvan de inhoud een exacte kopie is van het overeenkomstige veld in `raw_data`.

```{r}
taxon_core <- taxon_core %>%
  rename(
    "dwc_vernacularName"    = "raw_naam",
    "dwc_eventDate"         = "raw_datum",
    "dwc_year"              = "raw_jaar",
    "dwc_month"             = "raw_maand",
    "dwc_day"               = "raw_dag",
    "dwc_recordedBy"        = "raw_waarnemer",
    "dwc_individualCount"   = "raw_aantal",
    "dwc_locationID"        = "raw_plotnaam",
    "dwc_varbatimBehavior"  = "raw_wrntype_omschrijving",
    "dwc_occurrenceRemarks" = "raw_opmerk",
    "dwctaxonID"            = "raw_soortnr"
  )
```

**Vragen**

-  Ok dat `dwc_varbatimBehavior` de Nederlandstalige beschrijving is? De Engelstalige beschrijving wordt in de volgende sectie onder `dwc_behavior` aangemaakt. Of mag de Nederlandse beschrijving dan weg?
-  Is `raw_soortnr` SOVON specifiek?

## Gewijzigde waarden

Gewijzigde waarden worden gebruikt voor Darwin Core-termen waarvoor de inhoud in `raw_data` als basis wordt gebruikt, maar deze moet worden gestandaardiseerd. Dit geldt voor Darwin Core-termen waarvoor we een vocabulaire gebruiken of waar we willen transformeren voor de duidelijkheid of om duidelijke fouten te corrigeren.

- We creëren een `dwc_occurrenceID` en een `dwc_occurrenceID`
- We voegen `dwc_class` toe o.b.v. de `soortgrp`
- We voegen `dwc_occurrenceStatus` toe o.b.v. de `dwc_individualCount` 
- We voegen `dwc_behavior` toe als Engelse vertaling van `dwc_varbatimBehavior`

```{r}
taxon_core <- taxon_core %>%
  mutate(
    dwc_occurrenceID = paste0("MBAG:MAS:", .data$raw_oid),
    dwc_eventID = paste0("MBAG:MAS:",
                         .data$dwc_eventDate,
                         .data$dwc_locationID),
    dwc_class = ifelse(.data$raw_soortgrp == 2, "Aves", "Mammalia"),
    dwc_occurrenceStatus = ifelse(.data$dwc_individualCount > 0,
                                  "Present", "Absent"),
    dwc_behavior = case_when(
      .data$dwc_varbatimBehavior == "Territoriaal gedrag" ~
        "Teritorial behaviour",
      .data$dwc_varbatimBehavior == "Individu of groep niet plaatsgebonden" ~
        "Individual or group not bound to a location",
      .data$dwc_varbatimBehavior == "Volwassen individu in broedbiotoop" ~
        "Adult individual in breeding habitat",
      .data$dwc_varbatimBehavior == "Nestvondst" ~
        "Nest discovery",
      .data$dwc_varbatimBehavior == "Nest-aanduidend gedrag" ~
        "Nest-indicating behaviour",
      .data$dwc_varbatimBehavior == "Paar in broedbiotoop" ~
        "Pair in breeding habitat"
  )) %>%
  select(
    -"raw_oid",
    -"raw_soortgrp",
    -"raw_wrntype"
  )
```

**Vragen**

- We kunnen ook afwezigheden toevoegen (`dwc_occurrenceStatus = "absent"` en `dwc_individualCount = 0`) aangezien alle vogels worden genoteerd op het moment van tellen vanaf dat telpunt. Hoe doen we dit?
  - We kijken per jaar naar de lijst van soorten en voegen zo afwezigheden per telpunt toe op basis van deze lijst van soorten per jaar. *Voordeel:* geen verandering als er data van een nieuw jaar bijkomt. *Nadeel:* niet volledig aangezien deze lijst niet volledig is.
  - We kijken over de hele dataset naar de lijst van soorten en voegen zo afwezigheden per telpunt toe op basis van deze lijst van soorten. *Voordeel:* steeds meer volledige lijst van soorten. *Nadeel:* dataset zal elk jaar veranderen.
  - Afwezigheden toevoegen o.b.v. externe lijst?
  - ...

# Nabewerking
## Taxon matching

De soortcodes in `dwctaxonID` zijn avimapcodes.
We moeten matchen op de Nederlandstalige soortnamen in `dwc_vernacularName`.
Dit doen we via aangepaste code van in [deze gist](https://gist.github.com/damianooldoni/3fa9cc1ffa67377a9757df097d48d19f).

Een voorbeeldje waar het mis loopt.
Voor de Haas lukt het niet om een match te vinden.
Voor onzekere soorten, bv. Veldmuis/Aardmuis kiest de code voor de eerste match.

Voor zoogdieren lijkt deze code dus niet te werken.

```{r}
example_specs <- c(
  "Gele Kwikstaart",
  "Spreeuw",
  "Spreeuw",
  "Spreeuw",
  "Haas",
  "Steltkluut",
  "Veldmuis",
  "Aardmuis",
  "Veldmuis/Aardmuis",
  "Houtduif"
  )

vernacular_names_df <- tibble(
  id = seq_along(example_specs),
  dwc_vernacularName = example_specs
)

map_taxa_from_vernacular(
  vernacular_name_df = taxon_core,
  vernacular_name_col = "dwc_vernacularName",
  rank = "SPECIES",
  higherTaxonKey = 1)
```

We testen de code uit voor alle soorten in de data.

```{r}
species_names_mas <- taxon_core %>%
  distinct(dwctaxonID, dwc_vernacularName) %>%
  arrange(dwc_vernacularName)

species_matching_mas <- map_taxa_from_vernacular(
  vernacular_name_df = species_names_mas,
  vernacular_name_col = "dwc_vernacularName",
  out_cols = c("scientificName", "family", "order", "class"),
  rank = "SPECIES",
  higherTaxonKey = 1) %>%
  arrange(class, order, family, scientificName)

species_matching_mas %>%
  kable()
```

Voor meeste soorten komt het goed uit, maar voor een aantal soorten niet als de Nederlandse soortnaam in de wetenschappelijke naam voorkomt of in de auteursnaam.
Het ziet er niet naar uit dat we het niet zullen kunnen automatiseren.

Voor Vink en Haas vinden we geen soortnaam die matched.
Voor Merel is er ook geen mogelijkheid om automatisch de juiste naam te selecteren (zelfs als je een filter voor Aves zou inbouwen).

```{r}
rgbif::name_lookup(
  "Merel",
  datasetKey = "d7dddbf4-2cf0-4f39-9b2a-bb099caae36c",
  rank = "SPECIES",
  higherTaxonKey = 1)$data
```

## Volgorde kolommen

Volgorde van de kolommen aanpassen kan volgens:

```
col_order <- c( "type","language","license","rightsHolder","accessRights","datasetID"
               ,"institutionCode","datasetName","basisOfRecord","occurrenceID","recordedBy"
               ,"individualCount","organismQuantity","organismQuantityType","occurrenceStatus","occurrenceRemarks"
               ,"samplingProtocol","samplingEffort"
               ,"eventDate","continent","countryCode","municipality"
               ,"verbatimLatitude","verbatimLongitude","verbatimCoordinateSystem","verbatimSRS"
               ,"decimalLatitude","decimalLongitude","geodeticDatum","coordinateUncertaintyInMeters"
               ,"identifiedBy","scientificName","kingdom","scientificNameAuthorship","taxonRank","nomenclaturalCode"
               )
occurrence <- occurrence[, col_order]
```

# Conclusie
## Opmerkingen

De volgende kolommen van `raw_data` blijven over:

```{r}
sort(colnames(taxon_core)[grepl("^raw\\_", colnames(taxon_core))])
```

- Locaties telpunten ook in dataset (`raw_x_coord`, `raw_y_coord`, `raw_crs`) --> Event versus occurrence dataset opsplitsen?
- Afstand tot telpunt: `raw_distance2plot` --> welke term?
- Zijn variabelen relevant om mee te geven?
  - `raw_area_prop_sb` --> Overlap steekproefkader zenodo?
  - `raw_sbp` --> Overlap steekproefkader zenodo?
  - `raw_openheid_klasse` --> Overlap steekproefkader zenodo?
  - `raw_regio` --> Overlap steekproefkader zenodo?
  - `raw_predator`, `raw_n_predators_plot`: achteraf berekend, is de soort een predator of niet
  - `raw_periode_in_jaar`: 1 van 4 telperiodes
  - `raw_status_teller`: is de waarnemer een professional of een vrijwilliger?
- Kan hier nog iets mee gedaan worden?
  - `raw_doy`: day of year sinds januari
  - `raw_plotid`: we gebruiken eigenlijk altijd plotnaam
  - `raw_projectid`: is dit INBO of SOVON gerelateerd?

Zo ziet de dataset er voorlopig uit:

```{r}
taxon_core_final <- taxon_core %>%
  select(-starts_with("raw_")) %>%
  rename_with(~ gsub("dwc\\_", "", .x))

taxon_core_final %>%
  glimpse()
```
