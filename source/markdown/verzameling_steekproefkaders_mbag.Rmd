---
title: "Uitschrijven steekproefkaders MBAG"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Set up
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
knitr::opts_knit$set(
  root.dir = here::here())
```

```{r}
# Packages
library(tidyverse)
library(sf)
library(targets)
library(nngeo)

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::lag)

# Source
mbag_dir <- here::here()
data_path <- file.path(mbag_dir, "data", "steekproefkaders")

source(file.path(mbag_dir, "source", "R", "berekening_hulpvariabelen.R"))
source(file.path(mbag_dir, "source", "R", "steekproefkader.R"))
source(file.path(mbag_dir, "source", "R", "steekproeftrekking_nabehandeling.R"))
```

# Doel

We willen voor het MBAG project een duidelijk overzicht van het steekproefkader en de steekproef.
Hiervoor schrijven we voor 4 (groepen van) bestanden weg (als CSV-bestanden):

1.  steekproefkader

2.  gewichten steekproefkader per landbouwregio

3.  steekproef

4.  finale steekproef na manuele controle (punten die effectief zijn geteld)

# Data selectie en preparatie
## Leemstreek & Zandleemstreek

Meetnetontwerp voor deze regio's maakte deel uit van de MAS-pilootstudie.
Data selectie en preparatie voor deze regio's werd reeds gedaan in dat project.
De code vind je in [deze repository](https://github.com/inbo/mas-piloot).
We lezen de CSV-bestanden in.

```{r}
# Load sampling frame
steekproefkader_mbag_piloot <- read.csv(
  file.path(data_path, "steekproefkader_mbag_piloot.csv"))

# Load samples
steekproef_mbag_piloot <- read.csv(
  file.path(data_path, "steekproef_mbag_piloot.csv"))

# Load final samples
steekproef_avimap_mbag_piloot <- read.csv(
  file.path(data_path, "steekproef_avimap_mbag_piloot.csv"))
```

## Kempen, Polders & Zandstreek

Inlezen en preparatie steekproefkader.

```{r}
steekproefkader_za_kp_po_raw <- git2rdata::read_vc(
  file.path(
    "source", "targets", "mas_steekproef_za_kp_po", "output", "steekproefkader")
  )

# Prepare final dataframe
steekproefkader_za_kp_po <- steekproefkader_za_kp_po_raw %>%
  mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, regio = Naam, area_prop_sb, openheid_klasse, sbp, x_coord = X,
         y_coord = Y, crs) %>%
  filter(openheid_klasse %in% c("OL", "HOL"))
```

Inlezen en preparatie steekproef.

```{r}
steekproef_za_kp_po_raw <- git2rdata::read_vc(
  file.path(
    "source", "targets", "mas_steekproef_za_kp_po", "output", "steekproef")
  )

# Prepare final dataframe
steekproef_za_kp_po <- steekproef_za_kp_po_raw %>%
  st_drop_geometry() %>%
  mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, sample_order, batch, regio = Naam, area_prop_sb,
         openheid_klasse, sbp, x_coord = X, y_coord = Y, crs)
```

- in uncut in vervanging id kijken voor oude punten met volgnr <= 50
- in final kijken voor finale punten
-samenvoegen

```{r}
oud_zandstreek <- read.csv(
  file.path(
    data_path,
    "manual_check_johannes",
    "MAS netwerk Vlaanderen- steekproef_zandstreek_telpunten_uncut.csv")) %>%
  filter(sample_order <= 50,
         !startsWith(vervanging_id, "Zn") & vervanging_id != "") %>%
  select(regio = Naam, pointid = vervanging_id, openheid_sbp)

oud_kempen <- read.csv(
  file.path(
    data_path,
    "manual_check_johannes",
    "MAS netwerk Vlaanderen- steekproef_kempen_telpunten_uncut.csv")) %>%
  filter(sample_order <= 50,
         !startsWith(vervanging_id, "Km") & vervanging_id != "") %>%
  select(regio = Naam, pointid = vervanging_id, openheid_sbp)

oud_polders <- read.csv(
  file.path(
    data_path,
    "manual_check_johannes",
    "MAS netwerk Vlaanderen- steekproef_polders_telpunten_uncut.csv")) %>%
  filter(sample_order <= 50,
         !startsWith(vervanging_id, "Pl") & vervanging_id != "") %>%
  select(regio = Naam, pointid = vervanging_id, openheid_sbp)

oude_punten_za_kp_po <- bind_rows(
    oud_zandstreek,
    oud_kempen,
    oud_polders
  ) %>%
  left_join(steekproef_za_kp_po)

oude_punten_za_kp_po
```

> Probleem! Sommige oude telpunten zaten niet in steekproef. Iets misgelopen in targets?

We voegen de locaties toe aan de oude punten.

```{r}
extra_oude_punten <- st_read(
  path_to_existing(file = "avimap_601_0_MAS_Vlaanderen_telpunten_xy.shp")
  ) %>%
  distinct(naam, geometry) %>%
  st_transform(31370) %>%
  mutate(x_coord = st_coordinates(.data$geometry)[, 1],
         y_coord = st_coordinates(.data$geometry)[, 2])

oude_punten_za_kp_po_sf <- oude_punten_za_kp_po %>%
  filter(is.na(x_coord)) %>%
  select(-x_coord, -y_coord) %>%
  inner_join(extra_oude_punten, by = join_by(pointid == naam)) %>%
  mutate(crs = 31370) %>%
  st_sf()
```

We berekenen de sbp variabele.

```{r}
perimeters_za_kp_po <- st_read(path_to_perimeters("za_kp_po_perimeters.gpkg"))
sbp_akkervogels <- lapply(perimeters_za_kp_po$Naam, function(regio) {
  read_sbp_akkervogels(
      path = path_to_sbp_akkervogels(file = "akkervogelgebieden2022.shp"),
      gebied = perimeters_za_kp_po %>% filter(Naam == regio),
      path_extra_soorten = path_to_sbp_akkervogels(
        file = "sbp_overige_soorten.shp"),
      extra_soorten = c("hamster",
                        "bruine kiekendief",
                        "zomertortel", 
                        "grauwe kiekendief")
      )
})

sbp_akkervogels_joined <- do.call(rbind.data.frame, sbp_akkervogels)

oude_punten_sbp <- oude_punten_za_kp_po_sf %>%
  mutate(
    is_sbp = st_intersects(.data$geometry,
                           st_union(sbp_akkervogels_joined),
                           sparse = FALSE) %>%
           as.logical(),
    sbp = ifelse(.data$is_sbp, "binnen", "buiten")
  ) %>%
  select(-is_sbp)
```


> gelijkaardig bij zandleemstreek?

## Weidestreek

Inlezen en preparatie steekproefkader.

```{r}
steekproefkader_weidestreek_raw <- git2rdata::read_vc(
  file.path(
    "source", "targets", "mas_steekproef_weidestreek", "output", "steekproefkader")
  )

# Prepare final dataframe
steekproefkader_weidestreek <- steekproefkader_weidestreek_raw %>%
  mutate(Naam = "Weidestreek",
         sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, regio = Naam, area_prop_sb, openheid_klasse, sbp, x_coord = X,
         y_coord = Y, crs) %>%
  filter(openheid_klasse %in% c("OL", "HOL"))
```

Inlezen en preparatie steekproef.

```{r}
steekproef_weidestreek_raw <- git2rdata::read_vc(
  file.path(
    "source", "targets", "mas_steekproef_weidestreek", "output", "steekproef")
  )

# Prepare final dataframe
steekproef_weidestreek <- steekproef_weidestreek_raw %>%
  st_drop_geometry() %>%
  mutate(Naam = "Weidestreek",
         sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, sample_order, batch, regio = Naam, area_prop_sb,
         openheid_klasse, sbp, x_coord = X, y_coord = Y, crs)
```

Inlezen en preparatie finale punten die in avimap zijn ingevoerd.

- zie MAS netwerk Vlaanderen- weidestreek_kempen_telpunten-final.csv


# Uitschrijven datasets

> zandleemstreek, zandstreek en weidestreek pointids aanpassen!

## Steekproefkader

Dit is een CSV-bestand van alle steekproefkaders.

## Gewichten steekproefkader

Dit zijn aparte CSV-bestanden voor elke regio.

## Steekproef

Dit is een CSV-bestand van alle steekproeven.

## Finale steekproef na manuele controle

Dit is een CSV-bestand van alle finale telpunten.
