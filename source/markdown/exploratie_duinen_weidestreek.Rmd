---
title: "Exploratie landbouwstreken Duinen en Weidestreek"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# packages
library(tidyverse)
library(sf)
library(terra)
library(nngeo)
library(GVI)
library(mapview)

# source
mbag_dir <- here()
source(here("source", "R", "steekproefkader.R"))
source(here("source", "R", "berekening_hulpvariabelen.R"))
source(here("source", "R", "geocomputations.R"))
```

# Inlezen kaartlagen

```{r, results="hide"}
landbouwstreken <- st_read(here("data", "landbouwstreken", "Lbstrvl.gpkg"))
landbouwstreken <- landbouwstreken %>%
  mutate(Naam = ifelse(startsWith(NAAM, "Weidestreek"),
                       "Weidestreek", NAAM),
         section = NA) %>%
  select(Naam, section) %>%
  st_transform(31370)
```

We beschouwen `r nrow(landbouwstreken)` landbouwstreken in vlaanderen.

```{r}
ggplot() +
  geom_sf(data = landbouwstreken, aes(fill = Naam)) +
  ggtitle("Landbouwstreken in Vlaanderen")
```

We selecteren de Duinen en de Weidestreek.
Deze bekijken we hier apart omdat dit kleine gebieden zijn en we willen uitzoeken of het de moeite is om hier ook een steekproeftrekking uit te voeren.

```{r}
duinen_sf <- landbouwstreken %>%
  filter(Naam %in% c("Duinen"))
weidestreek_sf <- landbouwstreken %>%
  filter(Naam %in% c("Weidestreek"))

kleine_landbouwstreken <- list(
  Duinen = duinen_sf,
  Weidestreek = weidestreek_sf
)
```

# Berekening steekproefkader
## Openheid landschap

We kijken hoeveel open en halfopen landschap er aanwezig is in de Duinen en de Weidestreek.

```{r}
openheid_sf <- lapply(kleine_landbouwstreken, function(streek) {
  df_ol <- selectie_openheid(
      gebied = streek,
      ol_strata = c("OL")
      ) %>%
    mutate(openheid = "OL")
  df_hol <- selectie_openheid(
      gebied = streek,
      ol_strata = c("HOL")
      ) %>%
    mutate(openheid = "HOL")
  
  bind_rows(df_ol, df_hol)
})
```

```{r}
selectie_openheid_klasses <- lapply(kleine_landbouwstreken, function(streek) {
  selectie_openheid(
      gebied = streek,
      ol_strata = c("OL", "HOL")
      )
})
```

### Duinen

```{r}
mapview(kleine_landbouwstreken$Duinen, color = "red", alpha.regions = 0, legend = FALSE) +
  mapview(openheid_sf$Duinen, zcol = "openheid", layer = "openheid")
```

```{r}
area_duinen <- st_area(kleine_landbouwstreken$Duinen)
```

In de Duinen hebben we een totale oppervlakte van `r round(area_duinen*10^-6, 2)` km².
Een dikke 50 % hiervan is open en halfopen landschap, maar op basis van de verspreiding, lijkt het erop dat veel niet in landbouwgebied ligt (Westhoekreservaat, haven Zeebrugge ...).

```{r}
openheid_sf$Duinen %>%
  rowwise() %>%
  mutate(area = st_area(geom),
         prop_area = area / area_duinen) %>%
  st_drop_geometry() %>%
  select(Naam, openheid, area, prop_area) %>%
  kable()
```

`prop_area` is de proportie ten opzichte van de totale landbouwstreek.

### Weidestreek

```{r}
mapview(kleine_landbouwstreken$Weidestreek, color = "red", alpha.regions = 0, legend = FALSE) +
  mapview(openheid_sf$Weidestreek, zcol = "openheid", layer = "openheid")
```

```{r}
area_weidestreek <- st_area(kleine_landbouwstreken$Weidestreek)
```

In de Weidestreek hebben we een totale oppervlakte van `r round(area_weidestreek*10^-6, 2)` km².
Een dikke 60 % hiervan is open en halfopen landschap.

```{r}
openheid_sf$Weidestreek %>%
  rowwise() %>%
  mutate(area = st_area(geom),
         prop_area = area / area_weidestreek) %>%
  st_drop_geometry() %>%
  select(Naam, openheid, area, prop_area) %>%
  kable()
```

## Exclusie landgebruiken

OSM kaart gedownload op 27/02/2024.

> Er zijn in beide gebieden geen snelwegen aanwezig dus dit wordt niet in de functie gespecifieerd (anders krijgen we een error)

> Er is in de Weidestreek geen vliegveld aanwezig dus dit wordt niet in de functie gespecifieerd (anders krijgen we een error)

```{r, cache=TRUE, results="hide"}
exclusie_osm_duinen <- exclusie_landgebruik_osm(
    gebied = selectie_openheid_klasses$Duinen,
    osmdata = path_to_osm_download(),
    landuse = c("residential", "military", "industrial", "cemetery",
                "railway", "commercial", "farmyard"),
    leisure = c("park"),
    buffer_poly = 0,
    layer_poly = list(aeroway = c("aerodrome")),
    update_osm_layer = FALSE)

exclusie_osm_weidestreek <- exclusie_landgebruik_osm(
    gebied = selectie_openheid_klasses$Weidestreek,
    osmdata = path_to_osm_download(),
    landuse = c("residential", "military", "industrial", "cemetery",
                "railway", "commercial", "farmyard"),
    leisure = c("park"),
    update_osm_layer = FALSE)

exclusie_osm_landgebruiken <- list(
  Duinen = exclusie_osm_duinen,
  Weidestreek = exclusie_osm_weidestreek
)
```

### Duinen

In groen duiden we de exclusielaag aan.

```{r}
mapview(
    kleine_landbouwstreken$Duinen,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Duinen,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Duinen,
    col.regions = "green",
    legend = FALSE
  )
```

### Weidestreek

```{r}
mapview(
    kleine_landbouwstreken$Weidestreek,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Weidestreek,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Weidestreek,
    col.regions = "green",
    legend = FALSE
  )
```

## Extractie paden

```{r, cache=TRUE, results="hide"}
paden <- lapply(names(selectie_openheid_klasses), function(i) {
  extract_osm_paden(
    gebied = selectie_openheid_klasses[[i]],
    exclusie = exclusie_osm_landgebruiken[[i]],
    osmdata = path_to_osm_download(),
    paths_include = c("track", "tertiary", "tertiary_link", "unclassified"),
    cutting_exclude = NULL,
    historic_exclude = NULL,
    waterway = NULL,
    update_osm_layer = FALSE
    )
})
names(paden) <- names(selectie_openheid_klasses)
```

### Duinen

In blauw tonen we de paden die overblijven.

```{r}
mapview(
    kleine_landbouwstreken$Duinen,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Duinen,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Duinen,
    col.regions = "green",
    legend = FALSE
  ) +
  mapview(paden$Duinen, legend = FALSE)
```

```{r}
paden$Duinen %>%
  group_by(Naam, key, value) %>%
  summarise(.groups = "drop") %>%
  mutate(lengte_km = as.numeric(st_length(.)) / 1e3) %>%
  st_drop_geometry() %>%
  kable(digits = 2)
```

### Weidestreek

```{r}
mapview(
    kleine_landbouwstreken$Weidestreek,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Weidestreek,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Weidestreek,
    col.regions = "green",
    legend = FALSE
  ) +
  mapview(paden$Weidestreek, legend = FALSE)
```

```{r}
paden$Weidestreek %>%
  group_by(Naam, key, value) %>%
  summarise(.groups = "drop") %>%
  mutate(lengte_km = as.numeric(st_length(.)) / 1e3) %>%
  st_drop_geometry() %>%
  kable(digits = 2)
```

## Punten langs paden

```{r}
punten <- lapply(names(paden), function(i) {
  paden_naar_punten(
    data_paden = paden[[i]],
    gebieden = kleine_landbouwstreken[[i]],
    interpoint_distance = 50,
    border_distance = 300
    )
})
names(punten) <- names(paden)
```

### Duinen

```{r}
mapview(
    kleine_landbouwstreken$Duinen,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Duinen,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Duinen,
    col.regions = "green",
    legend = FALSE
  ) +
  mapview(paden$Duinen, legend = FALSE) +
  mapview(punten$Duinen, zcol = "value", layer = "Type weg of pad")
```

Overzicht aantal punten per categorie:

```{r}
punten$Duinen %>%
  st_drop_geometry() %>%
  count(Naam, key, value, name = "Aantal punten") %>%
  kable()
```

### Weidestreek

```{r}
mapview(
    kleine_landbouwstreken$Weidestreek,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Weidestreek,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Weidestreek,
    col.regions = "green",
    legend = FALSE
  ) +
  mapview(paden$Weidestreek, legend = FALSE) +
  mapview(punten$Weidestreek, zcol = "value", layer = "Type weg of pad")
```

Overzicht aantal punten per categorie:

```{r}
punten$Weidestreek %>%
  st_drop_geometry() %>%
  count(Naam, key, value, name = "Aantal punten") %>%
  kable()
```

## Selectie landgebruik VITO

We gebruiken volgende regel als criterium voor telpunten die in aanmerkingen komen voor wat betreft de samenstelling van het landgebruik in een buffer van 300 m rond het punt:

-   Akker + Grasland \> 40% én Grasland + Bos + Struikgewas + Akker \> 50%

```{r, cache=TRUE}
# Bereken landgebruik
telcirkels_landgebruik <- lapply(punten, function(streek) {
  punten_lum_buffer(
    punten_sf = streek,
    radius = 300,
    file = path_to_lum(jaar = 2019),
    legend = read_legend_lum(file = path_to_legend_lum())
    )
})

# Classificatie landgebruik
telcirkels_selectie_landgebruik <- lapply(telcirkels_landgebruik, function(streek) {
  punten_selectie_landgebruik(
    lum_extract_result = streek,
    legend_rast = read_legend_lum(file = path_to_legend_lum()),
    max_prop_overige = 0.5,
    min_prop_akker = 0.3,
    min_prop_akker_grasland = 0.4
    )
})

# Selecteer op landgebruik
selectie_landgebruik <- lapply(names(punten), function(i) {
  selectie_landgebruik_vito(
    punten_sf = punten[[i]],
    selectie_df = telcirkels_selectie_landgebruik[[i]]
    )
})
names(selectie_landgebruik) <- names(punten)

# Bereken punten die verwijderd worden
exclusie_punten <- lapply(names(punten), function(i) {
  punten[[i]] %>%
    left_join(
      telcirkels_selectie_landgebruik[[i]] %>%
        group_by(pointid) %>%
        summarize(selectie2 = any(selectie2)),
      by = "pointid"
    ) %>%
    filter(!selectie2)
})
names(exclusie_punten) <- names(punten)
```

### Duinen

De kaart toont de punten die op deze manier niet meer in aanmerkingen komen.

```{r}
mapview(
    kleine_landbouwstreken$Duinen,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Duinen,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Duinen,
    col.regions = "green",
    legend = FALSE
  ) +
  mapview(paden$Duinen, legend = FALSE) +
  mapview(exclusie_punten$Duinen, col.regions = "black",
          legend = FALSE)
```

```{r}
telcirkels_selectie_landgebruik$Duinen %>%
  ggtern::ggtern(aes(
    x = Akker + Grasland,
    y = Bos + Struikgewas,
    z = Overige
  )) +
  geom_point(
    alpha = 0.1,
    aes(colour = selectie2)
  )
```

### Weidestreek

```{r}
mapview(
    kleine_landbouwstreken$Weidestreek,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(
    selectie_openheid_klasses$Weidestreek,
    col.regions = "red",
    layer = "OL, HOL"
  ) +
  mapview(exclusie_osm_landgebruiken$Weidestreek,
    col.regions = "green",
    legend = FALSE
  ) +
  mapview(paden$Weidestreek, legend = FALSE) +
  mapview(exclusie_punten$Weidestreek, col.regions = "black",
          legend = FALSE)
```

```{r}
telcirkels_selectie_landgebruik$Weidestreek %>%
  ggtern::ggtern(aes(
    x = Akker + Grasland,
    y = Bos + Struikgewas,
    z = Overige
  )) +
  geom_point(
    alpha = 0.1,
    aes(colour = selectie2)
  )
```

## Selectie zichtbaarheid

```{r, cache=TRUE, results="hide"}
# Bereken zichtbaarheid
punten_zichtbaarheid <- lapply(selectie_landgebruik, function(streek) {
  add_visibility_to_frame(
    punten_sf = streek,
    resolution = 5,
    spacing = 10
    )
})

# Filter slechte zichtbaarheid
punten_selectie_zichtbaarheid <- lapply(punten_zichtbaarheid, function(streek) {
  filter_zichtbaarheid(
    punten_sf = streek,
    min_cvvi = 0.1
    )
})
```

### Duinen

In de Duinen vallen geen punten weg.

```{r}
ggplot(punten_zichtbaarheid$Duinen) +
  geom_histogram(aes(x = cvvi)) +
  geom_vline(xintercept = 0.1, colour = "firebrick") +
  scale_x_continuous(breaks = seq(0, 1, 0.1))
```

### Weidestreek

In de Weidestreek vallen een beperkt aantal punten weg.

```{r}
ggplot(punten_zichtbaarheid$Weidestreek) +
  geom_histogram(aes(x = cvvi)) +
  geom_vline(xintercept = 0.1, colour = "firebrick") +
  scale_x_continuous(breaks = seq(0, 1, 0.1))
```

# Stratificatie van het steekproefkader

```{r, results="hide"}
# Voeg proportie beheerovereenkomsten toe
plus_sb <- lapply(punten_selectie_zichtbaarheid, function(streek) {
  add_bo_to_frame(
    punten_df = streek,
    path_bo = path_to_bo(jaar = 2022)
    )
})

# Voeg stratum openheid landschap toe
plus_openheid_landschap <- lapply(names(plus_sb), function(i) {
  add_openheid_landschap_to_frame(
    path = path_to_openheid_landschap(),
    punten_sf = plus_sb[[i]],
    gebied = kleine_landbouwstreken[[i]],
    cutlevels = c(1.25, 1.35, 1.51),
    class_labels = c("GL", "HGL", "HOL", "OL")
    )
})
names(plus_openheid_landschap) <- names(plus_sb)

# Bereken SBP binnen landbouwstreken
sbp_akkervogels_duinen <- read_sbp_akkervogels(
  path = path_to_sbp_akkervogels(file = "akkervogelgebieden2022.shp"),
  gebied = kleine_landbouwstreken$Duinen,
  path_extra_soorten = path_to_sbp_akkervogels(file = "sbp_overige_soorten.shp"),
  extra_soorten = c("hamster", "bruine kiekendief", "zomertortel",
                    "grauwe kiekendief")
  )

sbp_akkervogels_weidestreek <- read_sbp_others(
  path_to_sbp_akkervogels(file = "sbp_overige_soorten.shp"),
  soorten = c("hamster", "bruine kiekendief", "zomertortel", "grauwe kiekendief"),
  gebied = kleine_landbouwstreken$Weidestreek
  ) %>%
  summarise()

sbp_akkervogels <- list(
  Duinen = sbp_akkervogels_duinen,
  Weidestreek = sbp_akkervogels_weidestreek
)

# Voeg SBP stratum toe aan finale punten
steekproefkader_finaal <- lapply(names(plus_openheid_landschap), function(i) {
  add_stratum_sbp(
    punten_sf = plus_openheid_landschap[[i]],
    sbp = sbp_akkervogels[[i]]
    ) %>%
    filter(openheid_klasse %in% c("OL", "HOL")) %>%
    mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
           stratum = paste(openheid_klasse, sbp, sep = " - ")
    )
})
names(steekproefkader_finaal) <- names(plus_openheid_landschap)
```

## Duinen

```{r}
steekproefkader_finaal$Duinen %>%
  st_drop_geometry() %>%
  count(stratum) %>%
  mutate(prop = n / sum(n)) %>%
  kable(digits = 3)
```

```{r}
mapview(
    kleine_landbouwstreken$Duinen,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(steekproefkader_finaal$Duinen, zcol = "stratum", layer = "stratum")
```

## Weidestreek

```{r}
steekproefkader_finaal$Weidestreek %>%
  st_drop_geometry() %>%
  count(stratum) %>%
  mutate(prop = n / sum(n)) %>%
  kable(digits = 3)
```

```{r}
mapview(
    kleine_landbouwstreken$Weidestreek,
    color = "red",
    alpha.regions = 0,
    legend = FALSE
  ) +
  mapview(steekproefkader_finaal$Weidestreek, zcol = "stratum", layer = "stratum")
```
