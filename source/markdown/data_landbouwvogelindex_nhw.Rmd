---
title: "Overzicht data voor landbouwvogelindex m.b.t. Europese Natuurherstelwet"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../output/rapporten/markdown/2025") })
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# packages
library(tidyverse)
library(INBOtheme)
library(sf)

theme_set(theme_inbo(transparent = TRUE))

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Paths
targets_store <- here::here("source", "targets", "data_preparation", "_targets")
```

# Doel
## Achtergrond

Voor de Europese Natuurherstelwet (NHW) bekijken we hoe en met welke data de landbouwvogelindex kan worden berekend.
Om het **MAS-meetnet** extra in de verf te zetten als noodzakelijke (beleids)monitoring, willen we meegeven voor welke soorten data uit **MAS** en **ABV** gebruikt kunnen worden.
België heeft net zoals de andere lidstaten de verplichting om per biogeografische regio op Belgisch niveau te rapporteren. Maar België is de enige lidstaat die per gewest (Wallonië en Vlaanderen) een (verschillende) lijst van indicatorsoorten heeft:

| Soort              | Lijst Vlaanderen      | Lijst Wallonië      | Monitoring Vlaanderen |
|--------------------|-----------------------|---------------------|-----------------------|
| Boerenzwaluw       | x                     | x                   | ABV + MAS             |
| Geelgors           | x                     | x                   | ABV + MAS             |
| Gele kwikstaart    | x                     | x                   | ABV + MAS             |
| Grasmus            | x                     | x                   | ABV + MAS             |
| Graspieper         | x                     | x                   | MAS ???               |
| Grauwe gors        |                       | x                   | BBV (WGG)             |
| Grauwe klauwier    |                       | x                   | BBV                   |
| Grutto             | x                     |                     | ???                   |
| Kievit             | x                     | x                   | ABV + MAS             |
| Kneu               | x                     | x                   | ABV + MAS             |
| Patrijs            | x                     | x                   | ABV + MAS             |
| Ringmus            | x                     | x                   | ABV + MAS             |
| Roek               |                       | x                   | BBV                   |
| Roodborsttapuit    | x                     | x                   | ABV + MAS             |
| Scholekster        | x                     |                     | ABV                   |
| Spreeuw            |                       | x                   | ABV + MAS             |
| Torenvalk          | x                     | x                   | ABV + MAS             |
| Veldleeuwerik      | x                     | x                   | ABV + MAS             |
| Wulp               | x                     |                     | ???                   |
| Zomertortel        |                       | x                   | ???                   |

Voor een aantal soorten is het **MAS-meetnet** ongetwijfeld beter en preciezer dan **ABV** in landbouwgebied.  
Om een verderzetting van MAS te beargumenteren, moeten we aantonen dat dit wettelijk noodzakelijk is voor de **NHW-rapportage** en voor de beleidsopvolging.

## Methode

- Voor de soorten uit bovenstaande tabel ga we na hoe vaak ze gezien zijn in MAS (2024) en ABV (laatste volledige cyclus, in landbouwstratum)
- Alle relevante cijfers worden samengebracht in een tabel (bv. ook totaal aantal telpunten/ km-hokken)

# Data inlezen

```{r}
indicator_species_nl <- c(
  "Boerenzwaluw",
  "Geelgors",
  "Gele Kwikstaart",
  "Grasmus",
  "Graspieper",
  "Grauwe Gors",
  "Grauwe Klauwier",
  "Grutto",
  "Kievit",
  "Kneu",
  "Patrijs",
  "Ringmus",
  "Roek",
  "Roodborsttapuit",
  "Scholekster",
  "Spreeuw",
  "Torenvalk",
  "Veldleeuwerik",
  "Wulp",
  "Zomertortel"
)
```

## MAS

Voor MAS filteren we de data van 2024. We selecteren de data van de doelsoorten.

```{r}
# Load data
mas_data_clean <- targets::tar_read("mas_data_clean", store = targets_store)

# Filter data by year
mas_2024_clean <- mas_data_clean %>%
  filter(jaar == 2024)

# Filter indicator species
mas_2024_indicator <- mas_2024_clean %>%
  filter(naam %in% indicator_species_nl)
```

We controleren of alle indicatorsoorten aanwezig zijn in deze dataset.

```{r}
identical(
  sort(unique(mas_2024_indicator[["naam"]])),
  sort(indicator_species_nl)
)

# Which
setdiff(indicator_species_nl, unique(mas_2024_indicator[["naam"]]))
```

## ABV

We downloaden de dataset: ABV - Common breeding birds in Flanders, Belgium (post 2016).
Ze wordt opgeslaan in de folder `data > abv > gbif_download_2025_04_28`.

> GBIF.org (28 April 2025) GBIF Occurrence Download https://doi.org/10.15468/dl.w3cmdg

```{r}
# Load ABV data
abv_data_dir <- here("data", "abv", "gbif_download_2025_04_28")
abv_data_post2016 <- read_delim(
  file.path(abv_data_dir, "occurrence.txt"),
  delim = "\t",
  show_col_types = FALSE
)

# Remove NA columns
abv_data_post2016 <- abv_data_post2016[, colSums(is.na(abv_data_post2016)) <
                                         nrow(abv_data_post2016)]

glimpse(abv_data_post2016)
```

We selecteren de data van de laatste 3-jarige cyclus en selecteren de data van de doelsoorten.
De laatste cyclus was 2022 - 2024.

```{r}
abv_indicator <- abv_data_post2016 %>%
  filter(
    year %in% 2022:2024,
    tolower(vernacularName) %in% tolower(indicator_species_nl)
  ) %>%
  mutate(vernacularName = stringr::str_to_title(vernacularName))
```

We controleren of alle indicatorsoorten aanwezig zijn in deze dataset.

```{r}
identical(
  sort(unique(abv_indicator[["vernacularName"]])),
  sort(indicator_species_nl)
)

# Which
setdiff(indicator_species_nl, unique(abv_indicator[["vernacularName"]]))
```


De Grauwe Gors werd niet gezien in de laatste cyclus.
Werd deze wel in andere jaren gezien?

```{r}
abv_data_post2016 %>%
  filter(tolower(vernacularName) %in% tolower("Grauwe Gors")) %>%
  select(verbatimLocality, year, verbatimLocality, individualCount, eventDate,
         level3Name, level2Name) %>%
  arrange(verbatimLocality, eventDate, desc(year), level3Name, level2Name) %>%
  kable()
```

We downloaden de stratum data van zenodo en voegen ze toe aan de dataset.


