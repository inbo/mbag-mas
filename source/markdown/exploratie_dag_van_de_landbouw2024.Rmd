---
title: "Data exploratie De Potter"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)
opts_knit$set(root.dir = here::here())
```

```{r}
# packages
library(tidyverse)
library(sf)
library(mapview)
library(targets)

library(INBOtheme)
theme_set(theme_inbo(transparent = TRUE))

# Conflicts
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Paths
mbag_dir <- here::here()
target_dir <- here::here("source", "targets", "data_preparation")
targets_store <- here::here("source", "targets", "data_preparation", "_targets")

media_folder <- here::here("media", "exploratie_gebied")
dir.create(media_folder, showWarnings = FALSE)

devices <- c("pdf", "png")

# Source
source(here::here("source", "R", "tar_read_sf.R"))
source(here::here("source", "R", "save_figure.R"))
lapply(list.files(file.path(target_dir, "R"), full.names = TRUE), source)
```

# Doel

We maken enkele figuren voor de "Dag van de landbouw" te Koksijde (15 september).

Hiervoor vergelijken we punten van het bedrijf De Potter in Wulpen (Nieuwpoort) met de omliggende regio:

- Depot2
- Depot3
- Depot5
- Pl_10446.2.18 
- Pl_10047.1.3

versus punten uit Polders OL (binnen plan).

Die vijf bovenvermelde punten zijn er die voor >75% velden bevatten van dit bedrijf, waar brede graskruiden akkerranden (al 15 jaar en 30m breed!) liggen, en waarbij niet-kerend en agroecologisch wordt gewerkt.
We vermoeden dat er significante verschillen kunnen zijn voor soorten als Haas, Veldleeuwerik, Kievit en misschien ook Gele kwikstaart.

# Data inlezen

We lezen in de data van gebied.
Behalve 1 punt behoren ze niet tot de steekproef voor MBAG MAS, dus we moeten nog verder deze waarnemingen opkuisen.
We selecteren enkel vogels en Haas.

```{r}
# Select data from De Potter
depot_locations <- c("Depot2", "Depot3", "Depot5", "Pl_10446.2.18", "Pl_10047.1.3")
crs_pipeline <- tar_read_sf("crs_pipeline", store = targets_store)
depot_data <- crs_pipeline %>%
  filter(plotnaam %in% depot_locations)
```

```{r}
# Data selection and preparation steps
depot_data_final <- select_within_time_periods(counts_df = depot_data) %>%
  mutate(regio = "Polders",
         openheid_klasse = "OL", 
         sbp = "binnen") %>%
  filter(.data$distance2plot <= 300,
         (.data$soortgrp == 2 | naam == "Haas")) %>%
  process_double_counted_data() %>%
  adjust_subspecies_names_nl()
```

We lezen in de MBAG MAS data van de Polders binnen sbp in open landschap.
We selecteren enkel vogels en Haas.

```{r}
# Select cleaned reference data from the correct stratum
mas_data_clean <- tar_read("mas_data_clean", store = targets_store)
mas_data_depot <- mas_data_clean %>%
  filter(regio == "Polders",
         sbp == "binnen",
         openheid_klasse == "OL",
         !plotnaam %in% depot_locations,
         (.data$soortgrp == 2 | naam == "Haas"))
```

De data voor de Polders is sterk uigespreid.

```{r}
mapview(depot_data_final) +
  mapview(mas_data_depot, col.regions = "red") 
```

We zullen een selectie maken voor de vergelijking.
We selecteren de data voor de westelijke Polders als alle punten ten westen van Oostende, Gistel, Torhout.

```{r}
mas_data_depot <- mas_data_depot %>%
          filter(x_lambert < 50990)
mapview(depot_data_final) +
  mapview(mas_data_depot, col.regions = "red")
```

We voegen de data samen.

```{r}
analysis_data <- bind_rows(mas_data_depot, depot_data_final) %>%
  mutate(gebied = ifelse(plotnaam %in% depot_locations,
                         "De Potter", "Referentie"))
```

```{r}
analysis_data %>%
  st_drop_geometry() %>%
  group_by(gebied) %>%
  mutate(
    aantal_soorten = n_distinct(naam),
    aantal_waarnemingen = n_distinct(oid),
    aantal_telpunten = n_distinct(plotid)
  ) %>%
  ungroup() %>%
  distinct(
    gebied, regio, openheid_klasse, sbp, aantal_soorten, aantal_waarnemingen, aantal_telpunten
  )
```

# Data exploratie

```{r}
# Number of species counted in each period
analysis_data %>%
  group_by(gebied, periode_in_jaar, plotnaam) %>%
  summarise(n = n_distinct(naam), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, fill = gebied)) +
  geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_boxplot() +
  labs(x = "Telperiode", y = "Aantal soorten per telpunt", fill = "Gebied")
```


```{r}
# Number of observations counted in each period
analysis_data %>%
  count(gebied, periode_in_jaar, plotnaam) %>%
  ggplot(aes(x = periode_in_jaar, y = n)) +
  geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
  geom_boxplot() +
  facet_wrap(~gebied) +
  labs(x = "Telperiode", y = "Aantal waarnemingen per telpunt")
```
